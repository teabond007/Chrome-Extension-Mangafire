(()=>{"use strict";const e={Reading:"#4ade80",Completed:"#60a5fa","Plan to Read":"#fbbf24","On-Hold":"#f97316","On Hold":"#f97316",Dropped:"#ef4444","Re-reading":"#a855f7",HasHistory:"#9ca3af"};class t{static create(e,n,a={}){const r=document.createElement("div");r.className="bmh-quick-tooltip",r.dataset.entryId=e.slug||e.id||"";const s="episode"===n.unitName?"Ep.":"Ch.",o=parseFloat(e.lastReadChapter)||0,i=t.calculateNextChapter(e),l=t.getStatusColor(e.status),c=e.personalData?.rating||0,d=o>0;return r.innerHTML=`\n            <button class="bmh-tt-btn bmh-tt-continue ${d?"":"bmh-btn-disabled"}" \n                    data-action="continue" \n                    title="${d?`Continue ${s} ${i}`:`Start Reading ${s} 1`}">\n                ▶\n            </button>\n            <button class="bmh-tt-btn bmh-tt-status" data-action="status" title="${e.status||"Set Status"}" style="--status-color: ${l}">\n                <span class="bmh-tt-status-dot" style="background: ${l}"></span>\n            </button>\n            <button class="bmh-tt-btn bmh-tt-rating" data-action="rating" title="Rating: ${c}/10">\n                ${c>0?c:"★"}\n            </button>\n            <button class="bmh-tt-btn bmh-tt-info" data-action="details" title="View Details">\n                ℹ\n            </button>\n        `,t.attachEventListeners(r,e,a),r}static createExpanded(e,n,a={}){const r=document.createElement("div");r.className="bmh-quick-actions bmh-qa-expanded",r.dataset.entryId=e.slug||e.id||"";const s="episode"===n.unitName?"Ep.":"Ch.",o=t.calculateNextChapter(e),i=e.personalData?.rating||0;return r.innerHTML=`\n            <div class="bmh-qa-content">\n                <button class="bmh-qa-btn bmh-qa-continue" data-action="continue" title="Continue to ${s} ${o}">\n                    <span class="bmh-qa-icon">▶</span>\n                    Continue ${s} ${o}\n                </button>\n                <button class="bmh-qa-btn bmh-qa-status" data-action="status" title="Change reading status">\n                    <span class="bmh-qa-status-indicator" style="background: ${t.getStatusColor(e.status)}"></span>\n                    ${e.status||"Add to Library"}\n                </button>\n                <div class="bmh-qa-row">\n                    <div class="bmh-qa-rating" data-action="rating" title="Rate (${i}/10)">\n                        ${t.renderRatingBadge(i)}\n                    </div>\n                    <button class="bmh-qa-btn bmh-qa-details" data-action="details" title="View details">\n                        <span class="bmh-qa-icon">ℹ️</span>\n                    </button>\n                </div>\n            </div>\n        `,t.attachEventListeners(r,e,a),r}static attachEventListeners(e,t,n){e.querySelectorAll("[data-action]").forEach(e=>{e.addEventListener("click",a=>{a.stopPropagation(),a.preventDefault();const r=e.dataset.action;n[r]&&n[r](t,e,a)})})}static calculateNextChapter(e){const t=parseFloat(e.lastReadChapter)||0;return Math.floor(t)+1}static renderRatingBadge(e){return!e||e<=0?'<span class="bmh-rating-badge bmh-rating-empty">-</span>':`<span class="bmh-rating-badge">${e}/10</span>`}static getStatusColor(e){return{reading:"#4ade80",completed:"#60a5fa","plan to read":"#fbbf24",planning:"#fbbf24","on-hold":"#f97316","on hold":"#f97316",dropped:"#ef4444","re-reading":"#a855f7",rereading:"#a855f7"}[(e||"").toLowerCase().trim()]||"rgba(255,255,255,0.3)"}static createStatusPicker(e,n,a=[]){const r=document.createElement("div");r.className="bmh-status-picker";const s=[{name:"Reading",color:"#4ade80"},{name:"Completed",color:"#60a5fa"},{name:"Plan to Read",color:"#fbbf24"},{name:"On-Hold",color:"#f97316"},{name:"Dropped",color:"#ef4444"},{name:"Re-reading",color:"#a855f7"},...a];return r.innerHTML=`\n            <div class="bmh-picker-header">Change Status</div>\n            <div class="bmh-picker-options">\n                ${s.map(t=>`\n                    <button class="bmh-picker-option ${e.status===t.name?"active":""}" \n                            data-status="${t.name}">\n                        <span class="bmh-picker-dot" style="background: ${t.color}"></span>\n                        ${t.name}\n                    </button>\n                `).join("")}\n            </div>\n        `,r.querySelectorAll("[data-status]").forEach(t=>{t.addEventListener("click",a=>{a.stopPropagation(),n?.(t.dataset.status,e),r.remove()})}),t.autoCloseOnOutsideClick(r),r}static createRatingPicker(e,n){const a=document.createElement("div");a.className="bmh-rating-picker";const r=e.personalData?.rating||0;a.innerHTML=`\n            <div class="bmh-picker-header">Rate (1-10)</div>\n            <div class="bmh-rating-grid">\n                ${[1,2,3,4,5,6,7,8,9,10].map(e=>`\n                    <button class="bmh-rating-num ${e===r?"active":""}" \n                            data-rating="${e}">\n                        ${e}\n                    </button>\n                `).join("")}\n            </div>\n            <button class="bmh-rating-clear" data-rating="0">Clear</button>\n        `;const s=a.querySelectorAll(".bmh-rating-num");return s.forEach((e,t)=>{e.addEventListener("mouseenter",()=>{s.forEach((e,n)=>{e.classList.toggle("hovered",n<=t)})})}),a.querySelector(".bmh-rating-grid").addEventListener("mouseleave",()=>{s.forEach(e=>e.classList.remove("hovered"))}),a.querySelectorAll("[data-rating]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();const s=parseInt(t.dataset.rating);n?.(s,e),a.remove()})}),t.autoCloseOnOutsideClick(a),a}static autoCloseOnOutsideClick(e){setTimeout(()=>{const t=n=>{e.contains(n.target)||(e.remove(),document.removeEventListener("click",t))};document.addEventListener("click",t)},0)}static autoCloseOnOutsideClick(e){setTimeout(()=>{const t=n=>{e.contains(n.target)||(e.remove(),document.removeEventListener("click",t))};document.addEventListener("click",t)},0)}static injectStyles(){if(document.getElementById("bmh-overlay-styles"))return;const e=document.createElement("style");e.id="bmh-overlay-styles",e.textContent="\n            /* ===== COMPACT TOOLTIP ===== */\n            .bmh-quick-tooltip {\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                display: flex;\n                gap: 4px;\n                opacity: 0;\n                transform: translateY(-4px);\n                transition: all 0.2s ease;\n                z-index: 60;\n                pointer-events: none;\n            }\n\n            [data-bmh-enhanced]:hover .bmh-quick-tooltip {\n                opacity: 1;\n                transform: translateY(0);\n                pointer-events: auto;\n            }\n\n            .bmh-tt-btn {\n                width: 28px;\n                height: 28px;\n                border: none;\n                border-radius: 6px;\n                background: rgba(0, 0, 0, 0.85);\n                color: #fff;\n                font-size: 12px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s ease;\n                backdrop-filter: blur(8px);\n                box-shadow: 0 2px 8px rgba(0,0,0,0.4);\n            }\n\n            .bmh-tt-btn:hover {\n                transform: scale(1.1);\n                background: rgba(30, 30, 30, 0.95);\n            }\n\n            .bmh-tt-continue {\n                background: linear-gradient(135deg, #4CAF50, #388e3c);\n            }\n\n            .bmh-tt-continue.bmh-btn-disabled {\n                background: rgba(80, 80, 80, 0.8);\n                opacity: 0.7;\n                filter: grayscale(1);\n                box-shadow: none;\n            }\n\n            .bmh-tt-continue:not(.bmh-btn-disabled):hover {\n                background: linear-gradient(135deg, #66BB6A, #43A047);\n            }\n\n            .bmh-tt-status-dot {\n                width: 10px;\n                height: 10px;\n                border-radius: 50%;\n            }\n\n            .bmh-tt-rating {\n                font-weight: 700;\n                color: #fbbf24;\n            }\n\n            .bmh-tt-info {\n                font-size: 14px;\n            }\n\n            /* ===== PICKERS (Status & Rating) ===== */\n            .bmh-status-picker,\n            .bmh-rating-picker {\n                position: fixed;\n                background: rgba(20, 20, 25, 0.98);\n                border: 1px solid rgba(255, 255, 255, 0.12);\n                border-radius: 12px;\n                padding: 12px;\n                min-width: 180px;\n                z-index: 10000;\n                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);\n                backdrop-filter: blur(16px);\n                animation: bmh-picker-slide 0.2s ease-out;\n            }\n\n            @keyframes bmh-picker-slide {\n                from { opacity: 0; transform: scale(0.95) translateY(-8px); }\n                to { opacity: 1; transform: scale(1) translateY(0); }\n            }\n\n            .bmh-picker-header {\n                font-size: 11px;\n                color: rgba(255, 255, 255, 0.5);\n                text-transform: uppercase;\n                letter-spacing: 1px;\n                padding-bottom: 8px;\n                margin-bottom: 8px;\n                border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n            }\n\n            .bmh-picker-options {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .bmh-picker-option {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                width: 100%;\n                padding: 10px 12px;\n                background: transparent;\n                border: none;\n                border-radius: 8px;\n                color: #fff;\n                font-size: 13px;\n                cursor: pointer;\n                transition: all 0.15s ease;\n                text-align: left;\n            }\n\n            .bmh-picker-option:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .bmh-picker-option.active {\n                background: rgba(255, 255, 255, 0.15);\n            }\n\n            .bmh-picker-dot {\n                width: 10px;\n                height: 10px;\n                border-radius: 50%;\n                flex-shrink: 0;\n            }\n\n            /* Rating Grid (1-10) */\n            .bmh-rating-grid {\n                display: grid;\n                grid-template-columns: repeat(5, 1fr);\n                gap: 6px;\n                margin-bottom: 10px;\n            }\n\n            .bmh-rating-num {\n                width: 36px;\n                height: 36px;\n                border: 1px solid rgba(255, 255, 255, 0.15);\n                border-radius: 8px;\n                background: transparent;\n                color: #fff;\n                font-size: 14px;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.15s ease;\n            }\n\n            .bmh-rating-num:hover,\n            .bmh-rating-num.hovered {\n                background: rgba(251, 191, 36, 0.3);\n                border-color: #fbbf24;\n                color: #fbbf24;\n            }\n\n            .bmh-rating-num.active {\n                background: #fbbf24;\n                border-color: #fbbf24;\n                color: #000;\n            }\n\n            .bmh-rating-clear {\n                width: 100%;\n                padding: 8px;\n                background: transparent;\n                border: 1px solid rgba(255, 255, 255, 0.1);\n                border-radius: 6px;\n                color: rgba(255, 255, 255, 0.6);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.15s ease;\n            }\n\n            .bmh-rating-clear:hover {\n                background: rgba(255, 255, 255, 0.08);\n                color: #fff;\n            }\n\n            /* Rating Badge */\n            .bmh-rating-badge {\n                color: #fbbf24;\n                font-weight: 600;\n                font-size: 13px;\n            }\n\n            .bmh-rating-empty {\n                opacity: 0.5;\n            }\n\n            /* Animation keyframes */\n            @keyframes bmh-pulse {\n                0%, 100% { opacity: 1; transform: scale(1); }\n                50% { opacity: 0.8; transform: scale(1.05); }\n            }\n        ",document.head.appendChild(e)}static injectPickerStyles(){t.injectStyles()}}class n{constructor(e,t={}){this.adapter=e,this.settings={highlighting:!1!==t.highlighting,progressBadges:!1!==t.progressBadges,quickActions:!0===t.quickActions,newChapterBadges:!0===t.newChapterBadges,border:{size:t.CustomBorderSize||4,style:t.borderStyle||"solid",radius:"8px"},customBookmarks:t.customBookmarks||[],customBookmarksEnabled:t.CustomBookmarksfeatureEnabled||!1}}async enhanceAll(){const e=this.findCards(),t=await this.loadLibrary();let n=0;for(const a of e){if(a.element.dataset.bmhEnhanced)continue;const e=this.findMatch(a,t);e&&(this.applyEnhancements(a,e),n++),a.element.dataset.bmhEnhanced="true"}return n}findCards(){const e=this.adapter.selectors.card;return e?Array.from(document.querySelectorAll(e)).map(e=>({element:e,data:this.adapter.extractCardData(e)})).filter(e=>e.data.title||e.data.id):[]}async loadLibrary(){return new Promise(e=>{chrome.storage.local.get(["savedEntriesMerged","userBookmarks","savedReadChapters"],t=>{if(chrome.runtime.lastError)return void e([]);const n=Array.isArray(t.savedEntriesMerged)?t.savedEntriesMerged:[],a=Array.isArray(t.userBookmarks)?t.userBookmarks:[],r=t.savedReadChapters||{},s=new Map;[...a,...n].forEach(e=>{if(e?.title){const t=this.findHistoryKey(e.title,e.slug,r);e.readChapters=t?r[t]:[],e.lastReadChapter=this.getHighestChapter(e.readChapters),s.set(e.title,e)}}),e(Array.from(s.values()))})})}findHistoryKey(e,t,n){if(!n)return null;if(t){const e=`${this.adapter.PREFIX||""}${t}`;if(n[e])return e;if(n[t])return t;if(t.includes(".")){const e=t.substring(0,t.lastIndexOf("."));if(n[e])return e}}if(n[e])return e;const a=this.normalizeTitle(e);for(const e of Object.keys(n))if(this.normalizeTitle(e)===a)return e;return null}findMatch(e,t){const n=t.find(t=>t.source===this.adapter.id&&t.sourceId===e.data.id);if(n)return n;const a=this.normalizeTitle(e.data.title);return t.find(e=>this.normalizeTitle(e.title)===a)}applyEnhancements(e,t){this.settings.highlighting&&this.applyBorder(e,t),this.settings.progressBadges&&t.readChapters?.length>0&&this.applyProgressBadge(e,t),this.settings.newChapterBadges&&t.hasNewChapters&&this.applyNewBadge(e),this.settings.quickActions&&this.applyQuickActions(e,t)}applyBorder(t,n){const a=n.status?.trim().toLowerCase()||"";let r="transparent",s=this.settings.border.style;for(const[t,n]of Object.entries(e))if(a.includes(t.toLowerCase())){r=n;break}if(this.settings.customBookmarksEnabled&&this.settings.customBookmarks.forEach(e=>{e.name&&a.includes(e.name.toLowerCase())&&(r=e.color,s=e.style||"solid")}),"transparent"!==r)if(this.adapter.applyBorder)this.adapter.applyBorder(t.element,r,this.settings.border.size,s);else{const e=t.element.closest("li")||t.element;e.style.setProperty("border",`${this.settings.border.size}px ${s} ${r}`,"important"),e.style.setProperty("border-radius",this.settings.border.radius,"important"),e.style.setProperty("box-sizing","border-box","important")}}applyProgressBadge(e,t){const n="episode"===this.adapter.unitName?"Ep.":"Ch.",a=t.chapters||t.anilistData?.chapters,r=a?`${n} ${t.lastReadChapter}/${a}`:`${n} ${t.lastReadChapter}+`,s=this.createBadge(r,"progress"),o=this.adapter.getBadgePosition?.()||{bottom:"4px",left:"4px"};Object.assign(s.style,o),this.insertBadge(e.element,s)}applyNewBadge(e){const t=this.createBadge("NEW","new");t.style.cssText+="top: 4px; right: 4px;",this.insertBadge(e.element,t)}applyQuickActions(e,n){t.injectStyles();const a={continue:(t,n,a)=>this.handleContinueReading(t,e),status:(t,n,a)=>this.handleStatusChange(t,n,e),rating:(t,n,a)=>this.handleRatingChange(t,n,e),details:(t,n,a)=>this.handleViewDetails(t,e)},r=t.create(n,this.adapter,a);e.element.style.position="relative",e.element.appendChild(r)}handleContinueReading(e,n){const a=t.calculateNextChapter(e),r=this.adapter.buildChapterUrl?.(e,a);r?window.location.href=r:e.mangafireUrl||e.sourceUrl?window.location.href=e.mangafireUrl||e.sourceUrl:n.data.url?window.location.href=n.data.url:console.log("[CardEnhancer] No URL available for continue reading:",e)}handleStatusChange(e,n,a){document.querySelectorAll(".bmh-status-picker").forEach(e=>e.remove());const r=t.createStatusPicker(e,(e,t)=>this.saveStatusChange(t,e),this.settings.customBookmarks),s=n.getBoundingClientRect();r.style.left=`${s.left}px`,r.style.top=`${s.bottom+8}px`,document.body.appendChild(r)}handleRatingChange(e,n,a){document.querySelectorAll(".bmh-rating-picker").forEach(e=>e.remove());const r=t.createRatingPicker(e,(e,t)=>this.saveRatingChange(t,e)),s=n.getBoundingClientRect();r.style.left=`${s.left}px`,r.style.top=`${s.bottom+8}px`,document.body.appendChild(r)}handleViewDetails(e,t){chrome.runtime.sendMessage({type:"showMangaDetails",title:e.title},()=>{chrome.runtime.lastError&&console.log("[CardEnhancer] Error opening details:",chrome.runtime.lastError)})}async saveStatusChange(e,t){try{const n=await new Promise(e=>{chrome.storage.local.get(["savedEntriesMerged","userBookmarks"],e)}),a=n.savedEntriesMerged||[],r=n.userBookmarks||[],s=a.findIndex(t=>this.normalizeTitle(t.title)===this.normalizeTitle(e.title));-1!==s&&(a[s].status=t);const o=r.findIndex(t=>this.normalizeTitle(t.title)===this.normalizeTitle(e.title));-1!==o&&(r[o].status=t),await new Promise(e=>{chrome.storage.local.set({savedEntriesMerged:a,userBookmarks:r},e)}),console.log(`[CardEnhancer] Status updated: ${e.title} → ${t}`),this.enhanceAll()}catch(e){console.error("[CardEnhancer] Failed to save status:",e)}}async saveRatingChange(e,t){try{const n=(await new Promise(e=>{chrome.storage.local.get(["savedEntriesMerged"],e)})).savedEntriesMerged||[],a=n.findIndex(t=>this.normalizeTitle(t.title)===this.normalizeTitle(e.title));-1!==a&&(n[a].personalData||(n[a].personalData={}),n[a].personalData.rating=t,await new Promise(e=>{chrome.storage.local.set({savedEntriesMerged:n},e)}),console.log(`[CardEnhancer] Rating updated: ${e.title} → ${t}`))}catch(e){console.error("[CardEnhancer] Failed to save rating:",e)}}createBadge(e,t){const n=document.createElement("div");return n.className=`bmh-badge bmh-badge-${t}`,n.textContent=e,n.style.cssText="\n            position: absolute;\n            background: rgba(0, 0, 0, 0.85);\n            color: #fff;\n            font-size: 11px;\n            font-weight: 600;\n            padding: 4px 8px;\n            border-radius: 6px;\n            z-index: 20;\n            pointer-events: none;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n            border: 1px solid rgba(255,255,255,0.1);\n        ","new"===t&&(n.style.background="#ef4444",n.style.animation="bmh-pulse 2s infinite"),n}insertBadge(e,t){const n=e.querySelector(`.bmh-badge-${t.classList[1]?.replace("bmh-badge-","")}`);n&&n.remove();const a=e.querySelector('div[class*="cover"], div[class*="thumb"], [class*="img"]')?.parentElement||e;a.style.position="relative",a.appendChild(t)}normalizeTitle(e){return e?e.toLowerCase().replace(/[^a-z0-9]/g,""):""}getHighestChapter(e){if(!e||0===e.length)return 0;let t=0;return e.forEach(e=>{const n=String(e).match(/^(\d+\.?\d*)/);if(n){const e=parseFloat(n[1]);e>t&&(t=e)}}),t}}const a=class{constructor(e={}){this.speed=e.speed||50,this.isRunning=!1,this.intervalId=null,this.showPanel=!1!==e.showPanel,this.panel=null,this.scrollTarget=null,this.lastScrollPos=-1,this.stuckCount=0}findScrollTarget(){const e=["#chapter-reader",".chapter-content",".reader-content",".reading-content","#content",".manga-reader",".read-container","main","article",".container"];for(const t of e){const e=document.querySelector(t);if(e){const t=window.getComputedStyle(e);if(("auto"===t.overflow||"scroll"===t.overflow||"auto"===t.overflowY||"scroll"===t.overflowY)&&e.scrollHeight>e.clientHeight)return{element:e,useElement:!0}}}const t=document.documentElement;if(document.body.scrollHeight>window.innerHeight||t.scrollHeight>window.innerHeight)return{element:window,useElement:!1};const n=document.querySelectorAll("*");for(const e of n)if(e.scrollHeight>e.clientHeight+100){const t=window.getComputedStyle(e);if("auto"===t.overflow||"scroll"===t.overflow||"auto"===t.overflowY||"scroll"===t.overflowY)return{element:e,useElement:!0}}return{element:window,useElement:!1}}getScrollPos(){return this.scrollTarget.useElement?this.scrollTarget.element.scrollTop:window.scrollY||window.pageYOffset||document.documentElement.scrollTop}doScroll(e){this.scrollTarget.useElement?this.scrollTarget.element.scrollTop+=e:window.scrollBy(0,e)}start(){if(this.isRunning)return;this.scrollTarget=this.findScrollTarget(),this.isRunning=!0,this.lastScrollPos=this.getScrollPos(),this.stuckCount=0;const e=this.speed/60;this.intervalId=setInterval(()=>{if(!this.isRunning)return void this.stop();this.doScroll(e);const t=this.getScrollPos();if(Math.abs(t-this.lastScrollPos)<.1){if(this.stuckCount++,this.stuckCount>60)return void this.stop()}else this.stuckCount=0;this.lastScrollPos=t},1e3/60),this.updatePanelState()}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.isRunning=!1,this.updatePanelState()}toggle(){this.isRunning?this.stop():this.start()}setSpeed(e){this.speed=Math.max(10,Math.min(300,e)),this.isRunning&&(this.stop(),this.start())}updatePanelState(){if(!this.panel)return;const e=this.panel.querySelector(".bmh-as-toggle");e&&(e.textContent=this.isRunning?"⏸ Stop":"▶ Start",e.className="bmh-as-toggle"+(this.isRunning?" active":""))}createControlPanel(){const e=document.querySelector(".bmh-autoscroll-panel");e&&e.remove();const t=document.createElement("div");t.className="bmh-autoscroll-panel",t.innerHTML=`\n            <button class="bmh-as-toggle" type="button">▶ Start</button>\n            <div class="bmh-as-speed-control">\n                <span class="bmh-as-label">Speed:</span>\n                <input type="range" class="bmh-as-speed" min="20" max="200" value="${this.speed}">\n                <span class="bmh-as-speed-value">${this.speed}</span>\n            </div>\n        `;const n=this;t.querySelector(".bmh-as-toggle").onclick=function(e){return e.preventDefault(),e.stopPropagation(),n.toggle(),!1};const a=t.querySelector(".bmh-as-speed"),r=t.querySelector(".bmh-as-speed-value");return a.oninput=function(e){const t=parseInt(e.target.value);n.setSpeed(t),r.textContent=t},this.injectStyles(),document.body.appendChild(t),this.panel=t,t}injectStyles(){if(document.getElementById("bmh-autoscroll-styles"))return;const e=document.createElement("style");e.id="bmh-autoscroll-styles",e.textContent="\n            .bmh-autoscroll-panel {\n                position: fixed !important;\n                bottom: 20px !important;\n                right: 20px !important;\n                background: rgba(0, 0, 0, 0.95) !important;\n                border: 1px solid rgba(255, 255, 255, 0.2) !important;\n                border-radius: 10px !important;\n                padding: 10px 14px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 10px !important;\n                z-index: 2147483647 !important;\n                font-family: -apple-system, BlinkMacSystemFont, sans-serif !important;\n                font-size: 13px !important;\n                color: white !important;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;\n            }\n            .bmh-as-toggle {\n                background: #4f46e5 !important;\n                color: white !important;\n                border: none !important;\n                padding: 8px 14px !important;\n                border-radius: 6px !important;\n                font-size: 12px !important;\n                font-weight: 600 !important;\n                cursor: pointer !important;\n                min-width: 70px !important;\n            }\n            .bmh-as-toggle:hover { background: #4338ca !important; }\n            .bmh-as-toggle.active { background: #dc2626 !important; }\n            .bmh-as-toggle.active:hover { background: #b91c1c !important; }\n            .bmh-as-speed-control {\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .bmh-as-label {\n                color: rgba(255, 255, 255, 0.7) !important;\n                font-size: 11px !important;\n            }\n            .bmh-as-speed {\n                width: 60px !important;\n                height: 4px !important;\n                -webkit-appearance: none !important;\n                background: rgba(255, 255, 255, 0.3) !important;\n                border-radius: 2px !important;\n            }\n            .bmh-as-speed::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                width: 12px !important;\n                height: 12px !important;\n                background: white !important;\n                border-radius: 50% !important;\n            }\n            .bmh-as-speed-value {\n                color: rgba(255, 255, 255, 0.9) !important;\n                font-size: 11px !important;\n                min-width: 24px !important;\n            }\n        ",document.head.appendChild(e)}init(){this.showPanel&&this.createControlPanel(),window.bmhAutoScroll=this}destroy(){this.stop(),this.panel&&(this.panel.remove(),this.panel=null),delete window.bmhAutoScroll}};class r{static defaults={ArrowDown:"scrollDown",ArrowUp:"scrollUp"," ":"toggleAutoScroll",Escape:"exitReader",f:"toggleFullscreen",F:"toggleFullscreen",n:"nextChapter",N:"nextChapter",p:"prevChapter",P:"prevChapter",Home:"scrollToTop",End:"scrollToBottom"};constructor(e){this.adapter=e,this.bindings=new Map,this.enabled=!0,this.boundHandler=this.handleKey.bind(this)}async loadBindings(){try{const e=(await chrome.storage.local.get("keybinds")).keybinds||{},t={...r.defaults,...e};Object.entries(t).forEach(([e,t])=>{this.bindings.set(e,t)}),console.log("[Keybinds] Loaded",this.bindings.size,"bindings")}catch(e){console.warn("[Keybinds] Failed to load bindings:",e),Object.entries(r.defaults).forEach(([e,t])=>{this.bindings.set(e,t)})}}async saveBindings(){try{const e=Object.fromEntries(this.bindings);await chrome.storage.local.set({keybinds:e})}catch(e){console.warn("[Keybinds] Failed to save bindings:",e)}}start(){document.addEventListener("keydown",this.boundHandler,{capture:!0}),console.log("[Keybinds] Started listening")}stop(){document.removeEventListener("keydown",this.boundHandler,{capture:!0}),console.log("[Keybinds] Stopped listening")}setEnabled(e){this.enabled=e}handleKey(e){if(!this.enabled)return;if(["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName))return;if(e.target.isContentEditable)return;if(e.ctrlKey||e.altKey||e.metaKey)return;const t=this.bindings.get(e.key);t&&(e.preventDefault(),e.stopPropagation(),this.executeAction(t))}executeAction(e){const t={nextPage:()=>this.adapter.goToNextPage?.()||this.scrollPage(1),prevPage:()=>this.adapter.goToPrevPage?.()||this.scrollPage(-1),nextChapter:()=>this.adapter.goToNextChapter?.(),prevChapter:()=>this.adapter.goToPrevChapter?.(),scrollDown:()=>window.scrollBy({top:.5*window.innerHeight,behavior:"smooth"}),scrollUp:()=>window.scrollBy({top:.5*-window.innerHeight,behavior:"smooth"}),scrollToTop:()=>window.scrollTo({top:0,behavior:"smooth"}),scrollToBottom:()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),toggleAutoScroll:()=>window.bmhAutoScroll?.toggle(),speedUp:()=>{window.bmhAutoScroll&&window.bmhAutoScroll.setSpeed(window.bmhAutoScroll.speed+20)},speedDown:()=>{window.bmhAutoScroll&&window.bmhAutoScroll.setSpeed(window.bmhAutoScroll.speed-20)},toggleFullscreen:()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(e=>{console.warn("[Keybinds] Fullscreen failed:",e)})},exitReader:()=>{document.fullscreenElement?document.exitFullscreen():this.adapter.exitReader?.()}}[e];t?(t(),console.log("[Keybinds] Executed:",e)):console.warn("[Keybinds] Unknown action:",e)}scrollPage(e){window.scrollBy({top:.5*window.innerHeight*e,behavior:"smooth"})}setBinding(e,t){this.bindings.set(e,t),this.saveBindings()}removeBinding(e){this.bindings.delete(e),this.saveBindings()}resetToDefaults(){this.bindings.clear(),Object.entries(r.defaults).forEach(([e,t])=>{this.bindings.set(e,t)}),this.saveBindings()}async init(){await this.loadBindings(),this.start(),window.bmhKeybinds=this,console.log("[Keybinds] Initialized")}destroy(){this.stop(),delete window.bmhKeybinds}}const s=r;class o{static SAVE_DELAY=5e3;constructor(e){this.adapter=e,this.currentEntry=null,this.saveTimeout=null,this.isSaved=!1}async init(){const e=this.parseCurrentUrl();e&&e.chapterNo?(this.currentEntry={source:this.adapter.id||this.adapter.PREFIX,slug:e.slug,id:e.id,chapter:String(e.chapterNo),url:window.location.href},console.log("[ProgressTracker] Tracking:",this.currentEntry),this.saveTimeout=setTimeout(()=>this.saveProgress(),o.SAVE_DELAY),this.setupScrollTracking()):console.log("[ProgressTracker] Not a chapter page, skipping")}parseCurrentUrl(){if(this.adapter.parseUrl)return this.adapter.parseUrl(window.location.href);const e=window.location.href,t=e.match(/\/read\/([^/]+)\.(\d+)\/\w+\/chapter-(\d+(?:\.\d+)?)/);if(t)return{slug:t[1],id:t[2],chapterNo:parseFloat(t[3])};const n=e.match(/mangadex\.org\/chapter\/([a-f0-9-]+)/i);if(n)return{chapterId:n[1],chapterNo:null};const a=e.match(/webtoons\.com.*episode_no=(\d+)/i);if(a){const t=e.match(/\/([^/]+)\/list\?/);return{slug:t?.[1]||"unknown",chapterNo:parseInt(a[1])}}return null}setupScrollTracking(){let e=!1;window.addEventListener("scroll",()=>{e||this.isSaved||window.scrollY/(document.body.scrollHeight-window.innerHeight)>.25&&(e=!0,this.saveProgress())},{passive:!0})}async saveProgress(){if(this.isSaved||!this.currentEntry)return;this.isSaved=!0;const{source:e,slug:t,chapter:n,url:a,id:r}=this.currentEntry;try{const s=t||`${e}:${r}`,o=await chrome.storage.local.get(["savedReadChapters","savedEntriesMerged"]),i=o.savedReadChapters||{},l=o.savedEntriesMerged||[];i[s]||(i[s]=[]),i[s].includes(n)||(i[s].push(n),i[s].sort((e,t)=>parseFloat(e)-parseFloat(t)));const c=l.find(n=>{if(n.source===e&&n.sourceId===r)return!0;if(n.slug===t||n.slug===s)return!0;const a=t?.toLowerCase().replace(/[^a-z0-9]/g,""),o=(n.slug||n.title||"").toLowerCase().replace(/[^a-z0-9]/g,"");return a&&a===o});if(c){parseFloat(n)>(parseFloat(c.lastReadChapter)||0)&&(c.lastReadChapter=n,c.lastMangafireUrl=a),c.lastReadDate=Date.now(),c.readChapters=i[s].length,console.log("[ProgressTracker] Updated library entry:",c.title||t)}await chrome.storage.local.set({savedReadChapters:i,savedEntriesMerged:l}),console.log(`[ProgressTracker] ✓ Saved progress: ${t} ch.${n}`);try{chrome.runtime.sendMessage({action:"progressSaved",data:{source:e,slug:t,chapter:n}})}catch(e){}}catch(e){console.error("[ProgressTracker] Failed to save progress:",e),this.isSaved=!1}}destroy(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null)}}const i=o,l=class{constructor(e,t={}){this.adapter=e,this.options={autoScroll:!1!==t.autoScroll,keybinds:!1!==t.keybinds,progressTracking:!1!==t.progressTracking},this.autoScroll=null,this.keybinds=null,this.progressTracker=null,this.isInitialized=!1}isReaderPage(){if(this.adapter.isReaderPage)return this.adapter.isReaderPage();const e=window.location.href;return[/\/read\//i,/\/chapter\//i,/episode_no=/i,/\/viewer/i,/chapter-\d+/i].some(t=>t.test(e))}async init(){if(!this.isReaderPage())return void console.log("[ReaderEnhancements] Not a reader page, skipping init");console.log("[ReaderEnhancements] Initializing on reader page...");const e=await this.loadSettings();this.options.autoScroll&&!1!==e.autoScrollEnabled&&(this.autoScroll=new a({speed:e.autoScrollSpeed||50,showPanel:!0}),this.autoScroll.init()),this.options.keybinds&&!1!==e.keybindsEnabled&&(this.keybinds=new s(this.adapter),await this.keybinds.init()),this.options.progressTracking&&!1!==e.progressTrackingEnabled&&(this.progressTracker=new i(this.adapter),await this.progressTracker.init()),this.isInitialized=!0,console.log("[ReaderEnhancements] Initialized successfully")}async loadSettings(){try{return await chrome.storage.local.get(["autoScrollEnabled","autoScrollSpeed","keybindsEnabled","progressTrackingEnabled"])}catch(e){return console.warn("[ReaderEnhancements] Failed to load settings:",e),{}}}destroy(){this.autoScroll?.destroy(),this.keybinds?.destroy(),this.progressTracker?.destroy(),this.autoScroll=null,this.keybinds=null,this.progressTracker=null,this.isInitialized=!1}},c={id:"mangadex",name:"MangaDex",unitName:"chapter",PREFIX:"mangadex:",selectors:{card:'.manga-card, .hchaptercard, [class*="chapter-feed__container"]',cardTitle:'a[href*="/title/"] h6, a.title span, a.title, [class*="title"]',cardLink:'a[href*="/title/"]',cardCover:".manga-card-cover img, img"},extractCardData(e){let t="",n="",a="";const r=e.querySelector(this.selectors.cardLink);if(r){let s;n=r.href,a=this.extractUUID(n),s=e.classList.contains("hchaptercard")?e.querySelector('a[href*="/title/"] h6'):e.querySelector("a.title span")||e.querySelector("a.title")||e.querySelector('[class*="title"]'),t=s?.textContent?.trim()||""}return{id:a,title:t,slug:this.slugify(t),url:n}},extractUUID(e){if(!e)return"";const t=e.match(/\/(title|chapter)\/([a-f0-9-]{36})/i);return t?t[2]:""},slugify:e=>e?e.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""):"",applyBorder(e,t,n,a){let r;r=e.classList.contains("hchaptercard")?e.querySelector('a[href*="/title/"]')||e:e.querySelector(".manga-card-cover")||e,r.style.setProperty("border",`${n}px ${a} ${t}`,"important"),r.style.setProperty("border-radius","8px","important"),r.style.setProperty("box-sizing","border-box","important"),r.style.setProperty("position","relative","important"),e._bmhBorderTarget=r},getBadgePosition:()=>({bottom:"4px",left:"4px"}),buildChapterUrl:(e,t)=>null,isReaderPage:()=>window.location.href.includes("/chapter/"),parseUrl:e=>null,goToNextChapter(){const e=Array.from(document.querySelectorAll("a")).find(e=>e.textContent.includes("Next")||e.textContent.includes("next"));e&&e.click()},goToPrevChapter(){const e=Array.from(document.querySelectorAll("a")).find(e=>e.textContent.includes("Previous")||e.textContent.includes("Prev"));e&&e.click()},exitReader(){const e=document.querySelector('a[href*="/title/"]');e?e.click():window.history.back()}};function d(){if(!chrome.runtime?.id)return;const e=function(){const e=window.location.href.match(/\/chapter\/([a-f0-9-]{36})/i);return e?e[1]:null}();if(!e)return;const t=document.querySelector('[class*="title"]')||document.querySelector('a[href*="/title/"]'),n=t?.textContent?.trim();if(!n)return void h("Could not extract title from reader page");const a=document.querySelector('a[href*="/title/"]'),r=a?c.extractUUID(a.href):null,s=r?`${c.PREFIX}${r}`:n;chrome.storage.local.get(["savedReadChapters"],t=>{if(chrome.runtime.lastError)return;let a=t.savedReadChapters||{};a[s]||(a[s]=[]),a[s].includes(e)||(a[s].push(e),chrome.storage.local.set({savedReadChapters:a},()=>{chrome.runtime.lastError||h(`Saved chapter ${e} for ${n}`)})),chrome.runtime.sendMessage({type:"autoSyncEntry",title:n,chapter:e,slugWithId:`mangadex-${r||"unknown"}`,readChapters:a[s].length,source:"mangadex"},()=>{chrome.runtime.lastError})})}function h(e){if(!chrome.runtime?.id)return;const t="object"==typeof e?JSON.stringify(e):e;chrome.runtime.sendMessage({type:"log",text:`[MangaDex] ${t}`},()=>{chrome.runtime.lastError})}async function p(){if(!chrome.runtime?.id)return;h("MangaDex CardEnhancer v3.8.0 (Bundled) initializing..."),function(){if(document.getElementById("bmh-mangadex-styles"))return;const e=document.createElement("style");e.id="bmh-mangadex-styles",e.textContent="\n        @keyframes bmh-pulse {\n            0%, 100% { opacity: 1; transform: scale(1); }\n            50% { opacity: 0.8; transform: scale(1.05); }\n        }\n    ",document.head.appendChild(e),t.injectStyles()}();const e=await new Promise(e=>{chrome.storage.local.get(["MangaDexHighlightEnabled","MangaDexQuickActionsEnabled","CustomBorderSize","CustomBorderSizefeatureEnabled","CustomBookmarksfeatureEnabled","customBookmarks","MangaDexShowProgress"],t=>{chrome.runtime.lastError?e({}):e(t)})});if(!1===e.MangaDexHighlightEnabled)return void h("Highlighting disabled");const a=new n(c,{highlighting:!0,progressBadges:!1!==e.MangaDexShowProgress,quickActions:!1!==e.MangaDexQuickActionsEnabled,CustomBorderSize:e.CustomBorderSizefeatureEnabled?e.CustomBorderSize:4,CustomBookmarksfeatureEnabled:e.CustomBookmarksfeatureEnabled,customBookmarks:e.customBookmarks});let r;h(`Enhanced ${await a.enhanceAll()} cards (Quick Actions: ${!1!==e.MangaDexQuickActionsEnabled?"ON":"OFF"})`),window.location.href.includes("/chapter/")&&(d(),new l(c).init(),h("Reader enhancements initialized")),new MutationObserver(()=>{clearTimeout(r),r=setTimeout(()=>a.enhanceAll(),200)}).observe(document.body,{childList:!0,subtree:!0});let s=location.href;new MutationObserver(()=>{location.href!==s&&(s=location.href,document.querySelectorAll("[data-bmh-enhanced]").forEach(e=>{delete e.dataset.bmhEnhanced}),setTimeout(()=>a.enhanceAll(),500),location.href.includes("/chapter/")&&setTimeout(()=>{d(),new l(c).init()},1e3))}).observe(document,{subtree:!0,childList:!0})}window.addEventListener("load",()=>{setTimeout(p,500)})})();
//# sourceMappingURL=content-mangadex.js.map