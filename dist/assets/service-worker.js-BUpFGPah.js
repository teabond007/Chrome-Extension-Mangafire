const N="https://graphql.anilist.co";let x=0;const R=2e3,k=3,M=3e3,U=`
query ($search: String) {
  Page(page: 1, perPage: 5) {
    media(search: $search, type: MANGA, sort: SEARCH_MATCH) {
      id
      title {
        romaji
        english
        native
      }
      coverImage {
        large
        medium
      }
      description
      status
      format
      chapters
      volumes
      genres
      tags {
        name
        rank
      }
      averageScore
      popularity
      startDate {
        year
        month
        day
      }
      endDate {
        year
        month
        day
      }
      countryOfOrigin
      isAdult
      siteUrl
    }
  }
}
`;function S(t,e=!0){const a=e?Math.floor(Math.random()*500):0;return new Promise(d=>setTimeout(d,t+a))}function $(t,e=!1){let a=t.replace(/\s*\(.*?\)\s*/g," ").replace(/\s*\[.*?\]\s*/g," ").replace(/[:–—-]/g," ").replace(/\s+/g," ").trim();return e&&([/colored/gi,/remake/gi,/full color/gi,/digital/gi,/vertical/gi,/scanlation/gi,/official/gi,/ver/gi,/manga/gi,/manhwa/gi,/manhua/gi,/remastered/gi,/raw/gi,/chapter/gi,/ch\.\d+/gi,/v\.\d+/gi].forEach(u=>{a=a.replace(u," ")}),a=a.replace(/[^a-zA-Z0-9 ]/g," "),a=a.replace(/\s+/g," ").trim()),a}async function y(t,e=0){var f,p;const d=Date.now()-x;d<R&&await S(R-d),x=Date.now();let u=t;e===1&&(u=$(t,!1)),e>=2&&(u=$(t,!0));const n={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:U,variables:{search:u}})};try{const o=await fetch(N,n);if(o.status===429){if(e<k){const c=parseInt(o.headers.get("Retry-After")||"60"),i=Math.min(c*1e3,M*Math.pow(2,e));return console.warn(`[AniList] Rate limited. Waiting ${i/1e3}s before retry ${e+1}/${k}`),await S(i),y(t,e+1)}return console.error("[AniList] Rate limit exceeded after max retries"),null}if(o.status>=500)return console.warn(`[AniList] Server Error (${o.status}). Retrying...`),e<k?(await S(M*Math.pow(2,e)),y(t,e+1)):null;if(!o.ok)return console.error(`[AniList] HTTP error: ${o.status} for title: "${u}"`),e<k?(await S(M*Math.pow(2,e)),y(t,e+1)):null;const s=await o.json();if(s.errors)return console.warn("[AniList] API Error for title:",u,s.errors),e<2?y(t,e+1):null;if((p=(f=s.data)==null?void 0:f.Page)!=null&&p.media){const c=s.data.Page.media;return c.length===0?e<2?(console.log(`[AniList] No results for "${u}", trying next strategy...`),y(t,e+1)):null:[...c].sort((r,l)=>{const h=g=>g.format==="MANGA"?100:g.format==="ONE_SHOT"?10:g.format==="NOVEL"?5:50;return h(l)-h(r)})[0]}}catch(o){return console.error("[AniList] Network error:",o),e<k?(await S(M*Math.pow(2,e)),y(t,e+1)):null}return null}function B(t){try{chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage(t,()=>{const e=chrome.runtime.lastError})}catch{}}function m(t){const e=typeof t=="object"?JSON.stringify(t):t;console.log("[Scraper]",e),B({type:"log",text:e})}function L(t){m("scrapeBookmarksFromUnopenedTab() called");const e=`https://mangafire.to/user/bookmark?page=${t}`;m(`Page URL: ${e}`),chrome.tabs.create({url:e,active:!1},a=>{m(`New tab created with ID: ${a.id}`),setTimeout(()=>{chrome.scripting.executeScript({target:{tabId:a.id},args:[t],func:u=>{const n=s=>{try{chrome.runtime.sendMessage(s,()=>chrome.runtime.lastError)}catch{}};n({type:"log",text:"executing script"});const f=[],p=document.querySelector(".original.card-xs");if(!p){n({type:"log",text:"!!!Container not found. Are you logged In Mangafire?"}),n({type:"scrapeBookmarks",value:0});return}const o=p.querySelectorAll(":scope > div");if(o.length===0){n({type:"bookmarksExtracted"}),n({type:"scrapeBookmarks",value:0});return}o.forEach(s=>{const c=s.querySelector(".inner");if(c){const i=c.querySelector(".info a"),r=c.querySelector(".info .dropdown.width-limit.favourite button");i&&r&&(f.push({title:i.textContent.trim(),status:r.textContent.trim()}),n({type:"log",text:`Scraped: ${i.textContent.trim()} - ${r.textContent.trim()}`}))}}),n({type:"log",text:`Total scraped this page: ${f.length}`}),chrome.storage.local.get("userBookmarks",s=>{const i=(Array.isArray(s.userBookmarks)?s.userBookmarks:[]).concat(f);chrome.storage.local.set({userBookmarks:i},()=>{n({type:"log",text:`Bookmarks saved. Total: ${i.length}`}),n({type:"bookmarksExtracted"});const r=u+1;n({type:"scrapeBookmarks",value:r})})})}})},2e3)})}function T(t){m("scrapeReadMangasFromUnopenedTab() called");const e=`https://mangafire.to/user/reading?page=${t}`;m(`Page URL: ${e}`),chrome.tabs.create({url:e,active:!1},a=>{m(`New tab created with ID: ${a.id}`),setTimeout(()=>{chrome.scripting.executeScript({target:{tabId:a.id},args:[t],func:u=>{const n=s=>{try{chrome.runtime.sendMessage(s,()=>chrome.runtime.lastError)}catch{}},f=[],o=document.body.querySelectorAll(".inner .info");if(o.length===0){n({type:"bookmarksExtracted"}),n({type:"scrapeReadMangas",value:0});return}o.forEach(s=>{const c=s.querySelector("a");if(c){const i=c.textContent.trim();i&&f.push({title:i,status:"Read"})}}),n({type:"log",text:`Read mangas scraped: ${f.length}`}),chrome.storage.local.get("userBookmarks",s=>{const c=Array.isArray(s.userBookmarks)?s.userBookmarks:[],i=new Map(f.map(l=>[l.title.toLowerCase(),l]));c.forEach(l=>i.set(l.title.toLowerCase(),l));const r=Array.from(i.values());chrome.storage.local.set({userBookmarks:r},()=>{n({type:"log",text:`Read Mangas merged. Total: ${r.length}`}),n({type:"bookmarksExtracted"});const l=u+1;n({type:"scrapeReadMangas",value:l})})})}})},2e3)})}async function C(t,e,a,d){m(`handleAutoSyncEntry called for: ${t} (Ch. ${e})`),chrome.storage.local.get(["savedEntriesMerged","savedReadChapters","SmartAutoCompletefeatureEnabled"],async u=>{let n=Array.isArray(u.savedEntriesMerged)?u.savedEntriesMerged:[],f=u.savedReadChapters||{};const p=u.SmartAutoCompletefeatureEnabled||!1,o=r=>r.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),s=a?a.split(".")[0]:o(t),c=(r,l)=>{if(d)return d;const h=r.toLowerCase(),g=o(r),w=l?l.split(".")[0]:null,E=Object.keys(f).find(b=>{const A=b.toLowerCase(),v=o(b);return A===h||v===g||w&&(v===w||A===w)});return E?f[E].length:0};let i=n.findIndex(r=>{const l=r.title.toLowerCase(),h=r.mangaSlug?r.mangaSlug.split(".")[0]:o(r.title);return l===t.toLowerCase()||h===s});if(i!==-1){let r=n[i];if(m(`Updating existing entry: ${r.title}`),r.lastRead=Date.now(),r.lastChapterRead=e,r.readChapters=c(r.title,r.mangaSlug),a&&(r.mangaSlug=a),r.lastUpdated=Date.now(),a&&e&&(r.lastMangafireUrl=`https://mangafire.to/read/${a}/en/chapter-${e}`),p&&r.anilistData&&r.anilistData.chapters){const l=parseFloat(String(e).replace(/[^\d.]/g,""))||0;r.anilistData.status==="FINISHED"&&l>=r.anilistData.chapters&&r.anilistData.chapters>0&&r.status!=="Completed"&&(r.status="Completed",m(`Smart Auto-Complete: Marked ${r.title} as Completed`))}chrome.storage.local.set({savedEntriesMerged:n});return}m(`No match for ${t}, fetching metadata...`);try{let r=await y(t);if(r||(m(`No data found for ${t} on AniList`),r={status:"NOT_FOUND",lastChecked:Date.now(),title:{english:t},format:"Unknown"}),r&&r.id){let h=n.findIndex(g=>g.anilistData&&g.anilistData.id===r.id);if(h!==-1){let g=n[h];m(`Found existing entry via AniList ID match: ${g.title}`),g.lastRead=Date.now(),g.lastChapterRead=e,g.readChapters=c(g.title,g.mangaSlug),a&&(g.mangaSlug=a),g.lastUpdated=Date.now(),a&&e&&(g.lastMangafireUrl=`https://mangafire.to/read/${a}/en/chapter-${e}`),chrome.storage.local.set({savedEntriesMerged:n});return}}m(`Creating new library entry for: ${t}`);const l={title:t,status:"Reading",readChapters:c(t,a)||1,lastChapterRead:e,mangaSlug:a,anilistData:r||null,customMarker:null,lastRead:Date.now(),lastUpdated:Date.now(),lastMangafireUrl:a&&e?`https://mangafire.to/read/${a}/en/chapter-${e}`:null};n.push(l),chrome.storage.local.set({savedEntriesMerged:n},()=>{m(`Auto-synced new entry ${t} to library`)})}catch(r){m(`Error auto-syncing ${t}: ${r.message}`)}})}chrome.runtime.onInstalled.addListener(t=>{console.log("[MangaManager] Extension installed/updated:",t.reason),t.reason==="install"&&chrome.storage.local.set({extensionEnabled:!0,NewTabDashboardfeatureEnabled:!1,AutoSyncfeatureEnabled:!1,notificationsEnabled:!1,libraryEntries:{}})});chrome.runtime.onMessage.addListener((t,e,a)=>{switch(console.log("[MangaManager] Message received:",t.type,t),t.type){case"scrapeBookmarks":return D(t.value,e),a({status:"received"}),!0;case"scrapeReadMangas":return F(t.value,e),a({status:"received"}),!0;case"freshSync":return _(a),!0;case"autoSyncEntry":return C(t.title,t.chapter,t.slugWithId,t.readChapters),a({status:"received"}),!0;case"bookmarksExtracted":return e.tab&&e.tab.id&&chrome.tabs.remove(e.tab.id).catch(()=>{}),a({status:"received"}),!0;case"log":return console.log("[Content Script]",t.text),a({status:"received"}),!0;case"GET_SETTINGS":return O(a),!0;case"UPDATE_READING_PROGRESS":return P(t.data,a),!0;case"SYNC_BOOKMARKS":return D(1,e),a({success:!0,message:"Sync started"}),!0;default:console.warn("[MangaManager] Unknown message type:",t.type),a({success:!1,error:"Unknown message type"})}});function D(t,e){t===0?(chrome.storage.local.set({SyncLastDate:Date.now()}),console.log("[MangaManager] Bookmark sync complete"),chrome.storage.local.get("SyncandMarkReadfeatureEnabled",a=>{a.SyncandMarkReadfeatureEnabled&&(console.log("[MangaManager] Starting reading history sync..."),T(1))}),e&&e.tab&&e.tab.id&&chrome.tabs.remove(e.tab.id).catch(()=>{})):L(t)}function F(t,e){t===0?(console.log("[MangaManager] Reading history sync complete"),e&&e.tab&&e.tab.id&&chrome.tabs.remove(e.tab.id).catch(()=>{})):T(t)}async function _(t){try{console.log("[MangaManager] Fresh sync started - clearing userBookmarks"),await chrome.storage.local.remove("userBookmarks"),L(1),t({success:!0,message:"Fresh sync started"})}catch(e){console.error("[MangaManager] Fresh sync error:",e),t({success:!1,error:e.message})}}async function O(t){try{const e=await chrome.storage.local.get(["extensionEnabled","NewTabDashboardfeatureEnabled","AutoSyncfeatureEnabled"]);t({success:!0,data:e})}catch(e){t({success:!1,error:e.message})}}async function P(t,e){try{const{libraryEntries:a}=await chrome.storage.local.get("libraryEntries"),d=a||{};d[t.id]&&(d[t.id]={...d[t.id],lastChapter:t.chapter,lastReadAt:Date.now(),lastReadUrl:t.url},await chrome.storage.local.set({libraryEntries:d})),e({success:!0})}catch(a){e({success:!1,error:a.message})}}console.log("[MangaManager] Background service worker initialized");
