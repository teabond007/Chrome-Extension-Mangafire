chrome.runtime.onInstalled.addListener(e=>{console.log("[MangaManager] Extension installed/updated:",e.reason),e.reason==="install"&&chrome.storage.local.set({extensionEnabled:!0,NewTabDashboardfeatureEnabled:!1,AutoSyncfeatureEnabled:!1,notificationsEnabled:!1})});chrome.runtime.onMessage.addListener((e,r,a)=>{switch(console.log("[MangaManager] Message received:",e.type,e),e.type){case"scrapeBookmarks":return u(e.value,r),a({status:"received"}),!0;case"scrapeReadMangas":return g(e.value,r),a({status:"received"}),!0;case"freshSync":return y(a),!0;case"autoSyncEntry":return p(e.title,e.chapter,e.slugWithId,e.readChapters),a({status:"received"}),!0;case"bookmarksExtracted":return r.tab&&r.tab.id&&chrome.tabs.remove(r.tab.id).catch(()=>{}),a({status:"received"}),!0;case"log":return console.log("[Content Script]",e.text),a({status:"received"}),!0;case"GET_SETTINGS":return k(a),!0;case"UPDATE_READING_PROGRESS":return M(e.data,a),!0;case"SYNC_BOOKMARKS":return u(1,r),a({success:!0,message:"Sync started"}),!0;default:console.warn("[MangaManager] Unknown message type:",e.type),a({success:!1,error:"Unknown message type"})}});function u(e,r){if(r&&r.tab&&r.tab.id&&chrome.tabs.remove(r.tab.id).catch(()=>{}),e===0){chrome.storage.local.set({SyncLastDate:Date.now()}),console.log("[MangaManager] Bookmark sync complete"),chrome.storage.local.get("SyncandMarkReadfeatureEnabled",o=>{o.SyncandMarkReadfeatureEnabled&&(console.log("[MangaManager] Starting reading history sync..."),g(1,null))});return}const a=`https://mangafire.to/user/bookmark?page=${e}`;console.log("[MangaManager] Opening bookmark page:",a),chrome.tabs.create({url:a,active:!1},o=>{if(chrome.runtime.lastError){console.error("[MangaManager] Tab creation error:",chrome.runtime.lastError);return}o.id,chrome.tabs.onUpdated.addListener(function s(t,n){t===o.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(s),chrome.scripting.executeScript({target:{tabId:o.id},args:[e],func:h}).catch(i=>{console.error("[MangaManager] Script injection error:",i),chrome.tabs.remove(o.id).catch(()=>{})}))})})}function h(e){const r=t=>{try{chrome.runtime.sendMessage(t,()=>chrome.runtime.lastError)}catch{}};r({type:"log",text:"Scraping bookmark page "+e});const a=[],o=document.querySelector(".original.card-xs");if(!o){r({type:"log",text:"Container not found. Are you logged into MangaFire?"}),r({type:"scrapeBookmarks",value:0});return}const s=o.querySelectorAll(":scope > div");if(s.length===0){r({type:"log",text:"No more bookmarks found, sync complete"}),r({type:"scrapeBookmarks",value:0});return}s.forEach(t=>{const n=t.querySelector(".inner");if(n){const i=n.querySelector(".info a"),c=n.querySelector(".info .dropdown.width-limit.favourite button");i&&c&&a.push({title:i.textContent.trim(),status:c.textContent.trim()})}}),r({type:"log",text:`Scraped ${a.length} bookmarks from page ${e}`}),chrome.storage.local.get("userBookmarks",t=>{const i=(Array.isArray(t.userBookmarks)?t.userBookmarks:[]).concat(a);chrome.storage.local.set({userBookmarks:i},()=>{r({type:"log",text:`Total bookmarks: ${i.length}`}),r({type:"scrapeBookmarks",value:e+1})})})}function g(e,r){if(r&&r.tab&&r.tab.id&&chrome.tabs.remove(r.tab.id).catch(()=>{}),e===0){console.log("[MangaManager] Reading history sync complete");return}const a=`https://mangafire.to/user/reading?page=${e}`;console.log("[MangaManager] Opening reading page:",a),chrome.tabs.create({url:a,active:!1},o=>{if(chrome.runtime.lastError){console.error("[MangaManager] Tab creation error:",chrome.runtime.lastError);return}chrome.tabs.onUpdated.addListener(function s(t,n){t===o.id&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(s),chrome.scripting.executeScript({target:{tabId:o.id},args:[e],func:f}).catch(i=>{console.error("[MangaManager] Script injection error:",i),chrome.tabs.remove(o.id).catch(()=>{})}))})})}function f(e){const r=s=>{try{chrome.runtime.sendMessage(s,()=>chrome.runtime.lastError)}catch{}},a=[],o=document.querySelectorAll(".inner .info");if(o.length===0){r({type:"scrapeReadMangas",value:0});return}o.forEach(s=>{const t=s.querySelector("a");if(t){const n=t.textContent.trim();n&&a.push({title:n,status:"Read"})}}),chrome.storage.local.get("userBookmarks",s=>{const t=Array.isArray(s.userBookmarks)?s.userBookmarks:[],n=new Map(a.map(c=>[c.title.toLowerCase(),c]));t.forEach(c=>n.set(c.title.toLowerCase(),c));const i=Array.from(n.values());chrome.storage.local.set({userBookmarks:i},()=>{r({type:"scrapeReadMangas",value:e+1})})})}async function y(e){try{console.log("[MangaManager] Fresh sync started - clearing userBookmarks"),await chrome.storage.local.remove("userBookmarks"),u(1,null),e({success:!0,message:"Fresh sync started"})}catch(r){console.error("[MangaManager] Fresh sync error:",r),e({success:!1,error:r.message})}}function p(e,r,a,o){chrome.storage.local.get(["savedEntriesMerged"],s=>{let t=Array.isArray(s.savedEntriesMerged)?s.savedEntriesMerged:[];const n=l=>l.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),i=a?a.split(".")[0]:n(e);let c=t.findIndex(l=>{const m=l.title.toLowerCase(),d=l.mangaSlug?l.mangaSlug.split(".")[0]:n(l.title);return m===e.toLowerCase()||d===i});c!==-1&&(t[c].lastRead=Date.now(),t[c].lastChapterRead=r,t[c].readChapters=o||t[c].readChapters,a&&(t[c].mangaSlug=a),chrome.storage.local.set({savedEntriesMerged:t}))})}async function k(e){try{const r=await chrome.storage.local.get(["extensionEnabled","NewTabDashboardfeatureEnabled","AutoSyncfeatureEnabled"]);e({success:!0,data:r})}catch(r){e({success:!1,error:r.message})}}async function M(e,r){try{const{libraryEntries:a}=await chrome.storage.local.get("libraryEntries"),o=a||{};o[e.id]&&(o[e.id]={...o[e.id],lastChapter:e.chapter,lastReadAt:Date.now(),lastReadUrl:e.url},await chrome.storage.local.set({libraryEntries:o})),r({success:!0})}catch(a){r({success:!1,error:a.message})}}console.log("[MangaManager] Background service worker initialized");
