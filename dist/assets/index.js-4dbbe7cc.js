import{f as R,a as C}from"./mangadex-api-9a5edea1.js";function E(e){try{chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage(e,()=>{const a=chrome.runtime.lastError;a&&a.message})}catch{}}function c(e){const a=typeof e=="object"?JSON.stringify(e):e;E({type:"log",text:a})}function b(e){c("scrapeBookmarksFromUnopenedTab() called");const a=`https://mangafire.to/user/bookmark?page=${e}`;c(`Page URL: ${a}`),chrome.tabs.create({url:a,active:!1},s=>{c(`New tab created with ID: ${s.id}`),chrome.scripting.executeScript({target:{tabId:s.id},args:[e],func:u=>{const r=i=>{try{chrome.runtime.sendMessage(i,()=>chrome.runtime.lastError)}catch{}};r({type:"log",text:"executing script"});const o=[],k=document.querySelector(".original.card-xs");if(!k)return r({type:"log",text:"!!!Container not found. Are you logged In Mangafire?"});const y=k.querySelectorAll(":scope > div");if(y.length===0){r({type:"bookmarksExtracted"}),r({type:"scrapeBookmarks",value:0});return}y.forEach(i=>{const d=i.querySelector(".inner");if(d){const g=d.querySelector(".info a");r({type:"log",text:`title: ${g.textContent.trim()}`});const p=d.querySelector(".info .dropdown.width-limit.favourite button");r({type:"log",text:`status: ${p.textContent.trim()}`}),g&&p?(o.push({title:g.textContent.trim(),status:p.textContent.trim()}),r({type:"log",text:`data pushed into Array. Array length: ${o.length}`})):r({type:"log",text:"title or statusBtn not found"})}}),r({type:"log",text:"bookmarks scraped"}),chrome.storage.local.get("userBookmarks",i=>{const g=(Array.isArray(i.userBookmarks)?i.userBookmarks:[]).concat(o);chrome.storage.local.set({userBookmarks:g},()=>{r({type:"log",text:`bookmarks saved. Array length: ${g.length}`}),r({type:"bookmarksExtracted"});const p=u+1;r({type:"log",text:`Next page value: ${p}`}),r({type:"scrapeBookmarks",value:p})})})}})})}function M(e){c("scrapReadMangasFromUnopenedTab() called");const a=`https://mangafire.to/user/reading?page=${e}`;c(`Page URL: ${a}`),chrome.tabs.create({url:a,active:!1},s=>{c(`New tab created with ID: ${s.id}`),chrome.scripting.executeScript({target:{tabId:s.id},args:[e],func:u=>{const r=i=>{try{chrome.runtime.sendMessage(i,()=>chrome.runtime.lastError)}catch{}},o=[],y=document.body.querySelectorAll(".inner .info");if(y.length===0){r({type:"log",text:"mangaDivs length is 0. this means there is zero mangas left"}),r({type:"bookmarksExtracted"}),r({type:"scrapeReadMangas",value:0});return}r({type:"log",text:"executing forEach loop"}),y.forEach(i=>{const d=i.querySelector("a").textContent.trim();d&&(o.push({title:d,status:"Read"}),r({type:"log",text:`title is : ${d} --- data pushed into Array. Array length: ${o.length}`}))}),r({type:"log",text:"Read Mangas scraped. forEach loop stopped"}),chrome.storage.local.get("userBookmarks",i=>{const d=Array.isArray(i.userBookmarks)?i.userBookmarks:[],g=new Map(o.map(m=>[m.title.toLowerCase(),m]));d.forEach(m=>g.set(m.title.toLowerCase(),m));const p=Array.from(g.values());chrome.storage.local.set({userBookmarks:p},()=>{r({type:"log",text:`Read Mangas saved. Total Array length: ${p.length}`}),r({type:"bookmarksExtracted"});const m=u+1;r({type:"scrapeReadMangas",value:m})})})}})})}async function A(e,a,s,u){c(`handleAutoSyncEntry called for: ${e} (Ch. ${a}) with slug: ${s}. Chapters: ${u||"unknown"}`),chrome.storage.local.get(["savedEntriesMerged","savedReadChapters","SmartAutoCompletefeatureEnabled"],async r=>{let o=Array.isArray(r.savedEntriesMerged)?r.savedEntriesMerged:[],k=r.savedReadChapters||{};const y=r.SmartAutoCompletefeatureEnabled||!1,i=t=>t.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),d=new Set,g=new Set;o.sort((t,n)=>!!t.anilistData!=!!n.anilistData?n.anilistData?1:-1:(n.lastRead||0)-(t.lastRead||0)),o=o.filter(t=>{if(t.anilistData&&t.anilistData.id){if(d.has(t.anilistData.id))return!1;d.add(t.anilistData.id)}const n=t.mangaSlug?t.mangaSlug.split(".")[0]:i(t.title);return g.has(n)?!1:(g.add(n),!0)});const p=s?s.split(".")[0]:i(e),m=(t,n)=>{if(u)return u;const v=t.toLowerCase(),h=i(t),l=n?n.split(".")[0]:null,D=Object.keys(k).find(S=>{const $=S.toLowerCase(),w=i(S);return $===v||w===h||l&&(w===l||$===l)});return D?k[D].length:0};let x=o.findIndex(t=>{const n=t.title.toLowerCase(),v=t.mangaSlug?t.mangaSlug.split(".")[0]:i(t.title);return n===e.toLowerCase()||v===p});if(x!==-1){let t=o[x];if(c(`Updating existing entry: ${t.title}. Preserving status: ${t.status||"Reading"}`),t.lastRead=Date.now(),t.lastChapterRead=a,t.readChapters=m(t.title,t.mangaSlug),s&&(t.mangaSlug=s),t.lastUpdated=Date.now(),s&&a&&(t.lastMangafireUrl=`https://mangafire.to/read/${s}/en/chapter-${a}`),y&&t.anilistData&&t.anilistData.chapters){const n=parseFloat(String(a).replace(/[^\d.]/g,""))||0;t.anilistData.status==="FINISHED"&&n>=t.anilistData.chapters&&t.anilistData.chapters>0&&t.status!=="Completed"&&(t.status="Completed",c(`Smart Auto-Complete: Marked ${t.title} as Completed (Ch. ${n}/${t.anilistData.chapters})`))}chrome.storage.local.set({savedEntriesMerged:o});return}c(`No match for ${e}, fetching metadata...`);try{let t=await R(e);if(t&&t.source!=="MANGADEX"&&!t.chapters){c(`AniList has no chapter count for ${e}, checking MangaDex...`);const h=await C(e);h&&h.chapters&&(t.chapters=h.chapters,c(`Found chapter count on MangaDex: ${h.chapters}`))}t||(c(`AniList returned no data for ${e}, trying MangaDex...`),t=await C(e));let n=t;if(t||(c(`No data found for ${e} on AniList or MangaDex. Marking as NOT_FOUND.`),n={status:"NOT_FOUND",lastChecked:Date.now(),title:{english:e},format:"Unknown"}),n&&n.id){let h=o.findIndex(l=>l.anilistData&&l.anilistData.id===n.id);if(h!==-1){let l=o[h];c(`Found existing entry via AniList ID match: ${l.title}. Updating history.`),l.lastRead=Date.now(),l.lastChapterRead=a,l.readChapters=m(l.title,l.mangaSlug),s&&(l.mangaSlug=s),l.lastUpdated=Date.now(),s&&a&&(l.lastMangafireUrl=`https://mangafire.to/read/${s}/en/chapter-${a}`),chrome.storage.local.set({savedEntriesMerged:o});return}}c(`Creating new library entry for: ${e}`);const v={title:e,status:"Reading",readChapters:m(e,s)||1,lastChapterRead:a,mangaSlug:s,anilistData:n||null,customMarker:null,lastRead:Date.now(),lastUpdated:Date.now(),lastMangafireUrl:s&&a?`https://mangafire.to/read/${s}/en/chapter-${a}`:null};o.push(v),chrome.storage.local.set({savedEntriesMerged:o},()=>{c(`Auto-synced new entry ${e} to library`)})}catch(t){c(`Error auto-syncing ${e}: ${t.message}`)}})}chrome.action.onClicked.addListener(()=>{chrome.tabs.create({url:chrome.runtime.getURL("src/options/options.html")})});chrome.runtime.onMessage.addListener((e,a,s)=>{if(e.type==="scrapeReadMangas")f("scrapeReadMangas message received"),e.value===0?(f("Message received: scrapeReadMangas. msg.value is 0. stopping further execution. everything is OK"),chrome.storage.local.set({SyncLastDate:Date.now()})):e.value===1?(f("Message received: scrapeReadMangas, value: 1"),f("Continuing scraping Mangas now scraping Read Mangas"),M(1)):(f(`Message received: scrapeReadMangas, value: ${e.value}`),M(e.value));else if(e.type==="scrapeBookmarks")e.value===0?(f("Message received: scrapeBookmarks. msg.value is 0. stopping further execution. everything is OK"),chrome.storage.local.get("SyncandMarkReadfeatureEnabled",u=>{u.SyncandMarkReadfeatureEnabled&&M(1)}),chrome.storage.local.set({SyncLastDate:Date.now()})):e.value===1?(chrome.storage.local.remove("userBookmarks"),f("Removed userBookmarks for a fresh restart"),f(`Message received: scrapeBookmarks, value: ${e.value}`),b(e.value)):(f(`Message received: scrapeBookmarks, value: ${e.value}`),b(e.value));else if(e.type==="autoSyncEntry")A(e.title,e.chapter,e.slugWithId,e.readChapters);else if(e.type==="showMangaDetails"){const u=encodeURIComponent(e.title||"");chrome.tabs.create({url:chrome.runtime.getURL(`src/options/options.html#library?showDetails=${u}`)})}else e.type==="bookmarksExtracted"&&(chrome.tabs.remove(a.tab.id),f("Tab closed after scraping"));return s({status:"received"}),!0});function f(e){const a=typeof e=="object"?JSON.stringify(e):e;L({type:"log",text:a})}function L(e){try{chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage(e,()=>{const a=chrome.runtime.lastError;a&&a.message})}catch{}}
