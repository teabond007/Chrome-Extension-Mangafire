import{f as R,a as E}from"./mangadex-api-9a5edea1.js";function u(e){const a=typeof e=="object"?JSON.stringify(e):e;chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage({type:"log",text:`[Scraper] ${a}`})}function w(e){u("scrapeBookmarksFromUnopenedTab() called");const a=`https://mangafire.to/user/bookmark?page=${e}`;u(`Page URL: ${a}`),chrome.tabs.create({url:a,active:!1},r=>{r.id&&(u(`New tab created with ID: ${r.id}`),chrome.scripting.executeScript({target:{tabId:r.id},args:[e],func:d=>{const o=s=>{try{chrome.runtime.sendMessage(s,()=>chrome.runtime.lastError)}catch{}};o({type:"log",text:"executing script"});const i=[],g=document.querySelector(".original.card-xs");if(!g)return o({type:"log",text:"!!!Container not found. Are you logged In Mangafire?"});const l=g.querySelectorAll(":scope > div");if(l.length===0){o({type:"bookmarksExtracted"}),o({type:"scrapeBookmarks",value:0});return}l.forEach(s=>{var n,f;const c=s.querySelector(".inner");if(c){const h=c.querySelector(".info a"),t=c.querySelector(".info .dropdown.width-limit.favourite button");h&&t&&i.push({title:((n=h.textContent)==null?void 0:n.trim())||"",status:((f=t.textContent)==null?void 0:f.trim())||""})}}),o({type:"log",text:`Scraped ${i.length} bookmarks`}),chrome.storage.local.get("userBookmarks",s=>{const n=(Array.isArray(s.userBookmarks)?s.userBookmarks:[]).concat(i);chrome.storage.local.set({userBookmarks:n},()=>{o({type:"bookmarksExtracted"}),o({type:"scrapeBookmarks",value:d+1})})})}}))})}function v(e){u("scrapeReadMangasFromUnopenedTab() called");const a=`https://mangafire.to/user/reading?page=${e}`;u(`Page URL: ${a}`),chrome.tabs.create({url:a,active:!1},r=>{r.id&&(u(`New tab created with ID: ${r.id}`),chrome.scripting.executeScript({target:{tabId:r.id},args:[e],func:d=>{const o=l=>{try{chrome.runtime.sendMessage(l,()=>chrome.runtime.lastError)}catch{}},i=[],g=document.querySelectorAll(".inner .info");if(g.length===0){o({type:"bookmarksExtracted"}),o({type:"scrapeReadMangas",value:0});return}g.forEach(l=>{var c;const s=l.querySelector("a");if(s){const n=(c=s.textContent)==null?void 0:c.trim();n&&i.push({title:n,status:"Read"})}}),chrome.storage.local.get("userBookmarks",l=>{const s=Array.isArray(l.userBookmarks)?l.userBookmarks:[],c=new Map(i.map(n=>[n.title.toLowerCase(),n]));s.forEach(n=>c.set(n.title.toLowerCase(),n)),chrome.storage.local.set({userBookmarks:Array.from(c.values())},()=>{o({type:"bookmarksExtracted"}),o({type:"scrapeReadMangas",value:d+1})})})}}))})}async function x(e,a,r,d){u(`handleAutoSyncEntry called for: ${e} (Ch. ${a})`),chrome.storage.local.get(["savedEntriesMerged","savedReadChapters","SmartAutoCompletefeatureEnabled"],async o=>{var h;let i=Array.isArray(o.savedEntriesMerged)?o.savedEntriesMerged:[];const g=o.savedReadChapters||{},l=o.SmartAutoCompletefeatureEnabled||!1,s=t=>t.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),c=r?r.split(".")[0]:s(e),n=(t,p)=>{if(d)return d;const y=t.toLowerCase(),k=p?p.split(".")[0]:null,M=Object.keys(g).find(S=>{const C=S.toLowerCase(),b=s(S);return C===y||b===s(y)||k&&(b===k||C===k)});return M?g[M].length:0},f=i.findIndex(t=>{const p=t.title.toLowerCase(),y=t.mangaSlug?t.mangaSlug.split(".")[0]:s(t.title);return p===e.toLowerCase()||y===c});if(f!==-1){let t=i[f];if(t.lastRead=Date.now(),t.lastChapterRead=a,t.readChapters=n(t.title,t.mangaSlug),r&&(t.mangaSlug=r),t.lastUpdated=Date.now(),r&&a&&(t.lastMangafireUrl=`https://mangafire.to/read/${r}/en/chapter-${a}`),l&&((h=t.anilistData)!=null&&h.chapters)){const p=parseFloat(String(a).replace(/[^\d.]/g,""))||0;t.anilistData.status==="FINISHED"&&p>=t.anilistData.chapters&&t.status!=="Completed"&&(t.status="Completed",u(`Smart Auto-Complete: Marked ${t.title} as Completed`))}chrome.storage.local.set({savedEntriesMerged:i});return}u(`No match for ${e}, fetching metadata...`);try{let t=await R(e);t||(t=await E(e));const p={title:e,status:"Reading",readChapters:n(e,r)||1,lastChapterRead:a,mangaSlug:r,anilistData:t||{status:"NOT_FOUND",lastChecked:Date.now(),title:{english:e}},lastRead:Date.now(),lastUpdated:Date.now(),lastMangafireUrl:r&&a?`https://mangafire.to/read/${r}/en/chapter-${a}`:null};i.push(p),chrome.storage.local.set({savedEntriesMerged:i},()=>{u(`Auto-synced new entry: ${e}`)})}catch(t){u(`Error auto-syncing ${e}: ${t.message}`)}})}chrome.action.onClicked.addListener(()=>{chrome.tabs.create({url:chrome.runtime.getURL("src/options/options.html")})});chrome.runtime.onMessage.addListener((e,a,r)=>{if(e.type==="scrapeReadMangas")m("scrapeReadMangas message received"),e.value===0?(m("Message received: scrapeReadMangas. msg.value is 0. stopping further execution. everything is OK"),chrome.storage.local.set({SyncLastDate:Date.now()})):e.value===1?(m("Message received: scrapeReadMangas, value: 1"),m("Continuing scraping Mangas now scraping Read Mangas"),v(1)):(m(`Message received: scrapeReadMangas, value: ${e.value}`),v(e.value));else if(e.type==="scrapeBookmarks")e.value===0?(m("Message received: scrapeBookmarks. msg.value is 0. stopping further execution. everything is OK"),chrome.storage.local.get("SyncandMarkReadfeatureEnabled",d=>{d.SyncandMarkReadfeatureEnabled&&v(1)}),chrome.storage.local.set({SyncLastDate:Date.now()})):e.value===1?(chrome.storage.local.remove("userBookmarks"),m("Removed userBookmarks for a fresh restart"),m(`Message received: scrapeBookmarks, value: ${e.value}`),w(e.value)):(m(`Message received: scrapeBookmarks, value: ${e.value}`),w(e.value));else if(e.type==="autoSyncEntry")x(e.title,e.chapter,e.slugWithId,e.readChapters);else if(e.type==="showMangaDetails"){const d=encodeURIComponent(e.title||"");chrome.tabs.create({url:chrome.runtime.getURL(`src/options/options.html#library?showDetails=${d}`)})}else e.type==="bookmarksExtracted"&&(chrome.tabs.remove(a.tab.id),m("Tab closed after scraping"));return r({status:"received"}),!0});function m(e){const a=typeof e=="object"?JSON.stringify(e):e;$({type:"log",text:a})}function $(e){try{chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage(e,()=>{const a=chrome.runtime.lastError;a&&a.message})}catch{}}
