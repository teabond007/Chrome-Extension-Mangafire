import{c as h,o as m,a as l,j as y,e as f,n as C,y as F,t as w,F as I,x as _,g as M,r as S,D as R,S as v,E as T}from"./storage-schema-5IIhgyd6.js";import{_ as $}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{a as D}from"./config-C-HYl_Rw.js";const q=":root{--bg-body: #0B1437;--bg-sidebar: #111C44;--bg-card: #111C44;--color-primary: #4318FF;--color-primary-rgb: 67, 24, 255;--color-accent: #6AD2FF;--color-bg-base: #0B1437;--color-bg-surface: #111C44;--color-bg-elevated: #111C44;--color-text-primary: #FFFFFF;--color-text-secondary: #A3AED0;--color-text-muted: #707EAE;--color-border: #2B3674;--color-glass-bg: #111C44;--color-success: #01B574;--color-warning: #FFB547;--color-error: #EE5D50;--color-info: #33L1CC}:root{--font-sans: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;--font-mono: JetBrains Mono, Fira Code, Consolas, monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--text-4xl: 2.25rem}:root{--shadow-sm: 0 1px 2px rgba(0, 0, 0, .3);--shadow-md: 0 4px 6px rgba(0, 0, 0, .35);--shadow-lg: 0 10px 15px rgba(0, 0, 0, .4);--shadow-xl: 0 20px 25px rgba(0, 0, 0, .45);--glow-primary: 0 0 20px rgba(100, 150, 255, .3);--glow-accent: 0 0 20px rgba(180, 100, 255, .3)}.overlay-container{display:contents}.quick-tooltip{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transform:translateY(-4px);transition:all .2s cubic-bezier(.4,0,.2,1);z-index:60;pointer-events:none}:host([visible]) .quick-tooltip,:host(:hover) .quick-tooltip{opacity:1;transform:translateY(0);pointer-events:auto}.action-btn{width:28px;height:28px;border:none;border-radius:6px;background:#000000d9;color:#fff;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s ease;-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);box-shadow:0 2px 8px #0006;padding:0}.action-btn:hover{transform:scale(1.1);background:#1e1e1ef2}.action-btn.disabled{opacity:.5;cursor:not-allowed;filter:grayscale(1)}.continue-btn{background:linear-gradient(135deg,#4caf50,#388e3c)}.continue-btn:hover:not(.disabled){background:linear-gradient(135deg,#66bb6a,#43a047)}.status-btn .status-dot{width:10px;height:10px;border-radius:50%;background-color:var(--status-color)}.rating-btn{color:#fbbf24}",z={class:"overlay-container"},Y={class:"quick-tooltip"},U=["title"],N=["title"],O=["title"],j={__name:"QuickActionsOverlay.ce",props:{entry:{type:Object,required:!0},statusColors:{type:Object,default:()=>({Reading:"#4ade80",Completed:"#60a5fa","Plan to Read":"#fbbf24","On-Hold":"#f97316",Dropped:"#ef4444","Re-reading":"#a855f7"})}},emits:["continue","open-status","open-rating","details"],setup(g,{emit:t}){const e=g,o=f(()=>e.entry.status||"Plan to Read"),r=f(()=>{var c;return((c=e.entry.personalData)==null?void 0:c.rating)||0}),s=f(()=>e.entry.lastReadChapter?parseFloat(e.entry.lastReadChapter):0),a=f(()=>!0),n=f(()=>s.value>0?s.value+1:1),p=f(()=>s.value>0?`Continue Ch. ${n.value}`:"Start Reading"),x=f(()=>e.statusColors[o.value]||"#9ca3af");return(c,i)=>(m(),h("div",z,[l("div",Y,[l("button",{class:C(["action-btn continue-btn",{disabled:!a.value}]),title:p.value,onClick:i[0]||(i[0]=y(u=>c.$emit("continue"),["stop"]))},[...i[4]||(i[4]=[l("span",{class:"icon"},"▶",-1)])],10,U),l("button",{class:"action-btn status-btn",title:o.value,style:F({"--status-color":x.value}),onClick:i[1]||(i[1]=y(u=>c.$emit("open-status",u),["stop"]))},[...i[5]||(i[5]=[l("span",{class:"status-dot"},null,-1)])],12,N),l("button",{class:"action-btn rating-btn",title:`Rating: ${r.value}/10`,onClick:i[2]||(i[2]=y(u=>c.$emit("open-rating",u),["stop"]))},w(r.value>0?r.value:"★"),9,O),l("button",{class:"action-btn info-btn",title:"View Details",onClick:i[3]||(i[3]=y(u=>c.$emit("details"),["stop"]))}," ℹ ")])]))}},V=$(j,[["styles",[q]]]),K=":root{--bg-body: #0B1437;--bg-sidebar: #111C44;--bg-card: #111C44;--color-primary: #4318FF;--color-primary-rgb: 67, 24, 255;--color-accent: #6AD2FF;--color-bg-base: #0B1437;--color-bg-surface: #111C44;--color-bg-elevated: #111C44;--color-text-primary: #FFFFFF;--color-text-secondary: #A3AED0;--color-text-muted: #707EAE;--color-border: #2B3674;--color-glass-bg: #111C44;--color-success: #01B574;--color-warning: #FFB547;--color-error: #EE5D50;--color-info: #33L1CC}:root{--font-sans: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;--font-mono: JetBrains Mono, Fira Code, Consolas, monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--text-4xl: 2.25rem}:root{--shadow-sm: 0 1px 2px rgba(0, 0, 0, .3);--shadow-md: 0 4px 6px rgba(0, 0, 0, .35);--shadow-lg: 0 10px 15px rgba(0, 0, 0, .4);--shadow-xl: 0 20px 25px rgba(0, 0, 0, .45);--glow-primary: 0 0 20px rgba(100, 150, 255, .3);--glow-accent: 0 0 20px rgba(180, 100, 255, .3)}.picker-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999}.picker-container{position:absolute;background:#141419fa;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;min-width:180px;box-shadow:0 12px 40px #0009;-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);animation:picker-slide .2s cubic-bezier(.2,.8,.2,1);display:flex;flex-direction:column;gap:8px}@keyframes picker-slide{0%{opacity:0;transform:scale(.95) translateY(-8px)}to{opacity:1;transform:scale(1) translateY(0)}}.picker-header{font-size:11px;color:#ffffff80;text-transform:uppercase;letter-spacing:1px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.08);font-weight:600}.picker-options{display:flex;flex-direction:column;gap:4px}.picker-option{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;background:transparent;border:none;border-radius:8px;color:#fff;font-size:13px;cursor:pointer;transition:all .15s ease;text-align:left;font-family:inherit}.picker-option:hover{background:#ffffff1a}.picker-option.active{background:#ffffff26;font-weight:500}.status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}",H={class:"picker-options"},Q=["onClick"],J={__name:"StatusPicker.ce",props:{currentStatus:{type:String,default:""},position:{type:Object,default:()=>({top:0,left:0})},statusColors:{type:Object,required:!0}},emits:["select","close"],setup(g){const t=g,e=f(()=>Object.entries(t.statusColors).map(([r,s])=>({name:r,color:s})).filter(r=>r.name!=="HasHistory")),o=f(()=>({top:`${t.position.top}px`,left:`${t.position.left}px`}));return(r,s)=>(m(),h("div",{class:"picker-overlay",onClick:s[0]||(s[0]=y(a=>r.$emit("close"),["self"]))},[l("div",{class:"picker-container",style:F(o.value)},[s[1]||(s[1]=l("div",{class:"picker-header"},"Change Status",-1)),l("div",H,[(m(!0),h(I,null,_(e.value,a=>(m(),h("button",{key:a.name,class:C(["picker-option",{active:g.currentStatus===a.name}]),onClick:n=>r.$emit("select",a.name)},[l("span",{class:"status-dot",style:F({background:a.color})},null,4),M(" "+w(a.name),1)],10,Q))),128))])],4)]))}},X=$(J,[["styles",[K]]]),G=":root{--bg-body: #0B1437;--bg-sidebar: #111C44;--bg-card: #111C44;--color-primary: #4318FF;--color-primary-rgb: 67, 24, 255;--color-accent: #6AD2FF;--color-bg-base: #0B1437;--color-bg-surface: #111C44;--color-bg-elevated: #111C44;--color-text-primary: #FFFFFF;--color-text-secondary: #A3AED0;--color-text-muted: #707EAE;--color-border: #2B3674;--color-glass-bg: #111C44;--color-success: #01B574;--color-warning: #FFB547;--color-error: #EE5D50;--color-info: #33L1CC}:root{--font-sans: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;--font-mono: JetBrains Mono, Fira Code, Consolas, monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--text-4xl: 2.25rem}:root{--shadow-sm: 0 1px 2px rgba(0, 0, 0, .3);--shadow-md: 0 4px 6px rgba(0, 0, 0, .35);--shadow-lg: 0 10px 15px rgba(0, 0, 0, .4);--shadow-xl: 0 20px 25px rgba(0, 0, 0, .45);--glow-primary: 0 0 20px rgba(100, 150, 255, .3);--glow-accent: 0 0 20px rgba(180, 100, 255, .3)}.picker-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999}.picker-container{position:absolute;background:#141419fa;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;min-width:180px;box-shadow:0 12px 40px #0009;-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);animation:picker-slide .2s cubic-bezier(.2,.8,.2,1)}@keyframes picker-slide{0%{opacity:0;transform:scale(.95) translateY(-8px)}to{opacity:1;transform:scale(1) translateY(0)}}.picker-header{font-size:11px;color:#ffffff80;text-transform:uppercase;letter-spacing:1px;padding-bottom:8px;margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,.08);font-weight:600}.rating-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:10px}.rating-num{width:36px;height:36px;border:1px solid rgba(255,255,255,.15);border-radius:8px;background:transparent;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s ease;padding:0;display:flex;align-items:center;justify-content:center;font-family:inherit}.rating-num:hover,.rating-num.hovered{background:#fbbf244d;border-color:#fbbf24;color:#fbbf24}.rating-num.active{background:#fbbf24;border-color:#fbbf24;color:#000}.rating-clear{width:100%;padding:8px;background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:6px;color:#fff9;font-size:12px;cursor:pointer;transition:all .15s ease;font-family:inherit}.rating-clear:hover{background:#ffffff14;color:#fff}",W={class:"rating-grid"},Z=["onMouseenter","onClick"],tt={__name:"RatingPicker.ce",props:{currentRating:{type:Number,default:0},position:{type:Object,default:()=>({top:0,left:0})}},emits:["select","close"],setup(g){const t=g,e=S(null),o=f(()=>({top:`${t.position.top}px`,left:`${t.position.left}px`}));return(r,s)=>(m(),h("div",{class:"picker-overlay",onClick:s[1]||(s[1]=y(a=>r.$emit("close"),["self"]))},[l("div",{class:"picker-container",style:F(o.value)},[s[2]||(s[2]=l("div",{class:"picker-header"},"Rate (1-10)",-1)),l("div",W,[(m(),h(I,null,_(10,a=>l("button",{key:a,class:C(["rating-num",{active:g.currentRating===a,hovered:e.value!==null&&a<=e.value}]),onMouseenter:n=>e.value=a,onClick:n=>r.$emit("select",a)},w(a),43,Z)),64))]),l("button",{class:"rating-clear",onClick:s[0]||(s[0]=a=>r.$emit("select",0))}," Clear Rating ")],4)]))}},et=$(tt,[["styles",[G]]]),ot=R(V);customElements.get("bmh-quick-actions")||customElements.define("bmh-quick-actions",ot);const rt=R(X);customElements.get("bmh-status-picker")||customElements.define("bmh-status-picker",rt);const st=R(et);customElements.get("bmh-rating-picker")||customElements.define("bmh-rating-picker",st);class bt{constructor(t){this.adapter=t,this.settings={highlighting:!0,quickActions:!0},this.library=new Map,this.observer=null,this.config=null}async init(){console.log(`[CardEnhancer] Initializing for ${this.adapter.name}...`),await this.loadSettings(),await this.loadLibrary(),this.enhanceVisibleCards(),this.startObserver(),chrome.storage.onChanged.addListener((t,e)=>{e==="local"&&(t[v.LIBRARY]&&this.loadLibrary().then(()=>this.enhanceVisibleCards()),(t.features||t.statusColors)&&this.loadSettings().then(()=>this.enhanceVisibleCards()))})}async loadSettings(){this.config=await D.load(),this.settings.highlighting=this.config.isFeatureEnabled("highlighting"),this.settings.quickActions=this.config.isFeatureEnabled("quickActions")}async loadLibrary(){const e=(await chrome.storage.local.get(v.LIBRARY))[v.LIBRARY]||[];this.library.clear(),e.forEach(o=>{o.sourceId&&this.library.set(`${o.source}:${o.sourceId}`,o),o.slug&&this.library.set(`${o.source}:${o.slug}`,o),o.slug&&o.source===this.adapter.id&&this.library.set(o.slug,o)})}startObserver(){this.observer=new MutationObserver(t=>{let e=!1;for(const o of t)if(o.addedNodes.length>0){e=!0;break}e&&(this._debounce&&clearTimeout(this._debounce),this._debounce=setTimeout(()=>this.enhanceVisibleCards(),200))}),this.observer.observe(document.body,{childList:!0,subtree:!0})}enhanceVisibleCards(){const t=this.adapter.selectors.card;if(!t)return;document.querySelectorAll(t).forEach(o=>this.enhanceCard(o))}enhanceCard(t){if(t.dataset.bmhEnhanced)return;const e=this.adapter.extractCardData(t);if(!e||!e.id&&!e.title)return;const o=this.findMatch(e);t.dataset.bmhEnhanced="true",t.addEventListener("mouseenter",()=>{const r=t.querySelector("bmh-quick-actions");r&&r.setAttribute("visible","")}),t.addEventListener("mouseleave",()=>{const r=t.querySelector("bmh-quick-actions");r&&r.removeAttribute("visible")}),this.settings.highlighting&&o&&this.applyBorder(t,o),this.settings.quickActions&&this.mountQuickActions(t,o||this.createTemporaryEntry(e))}findMatch(t){if(t.id){const e=`${this.adapter.id}:${t.id}`;if(this.library.has(e))return this.library.get(e)}if(t.slug){const e=`${this.adapter.id}:${t.slug}`;if(this.library.has(e))return this.library.get(e);if(this.library.has(t.slug))return this.library.get(t.slug)}return null}createTemporaryEntry(t){return{id:t.id,title:t.title,slug:t.slug,status:null,source:this.adapter.id,sourceUrl:t.url,lastReadChapter:null,personalData:{rating:0}}}applyBorder(t,e){const o=this.config?this.config.getStatusColor(e.status):"transparent";this.adapter.applyBorder?this.adapter.applyBorder(t,o):(t.style.border=`3px solid ${o}`,t.style.borderRadius="8px")}mountQuickActions(t,e){const o=document.createElement("bmh-quick-actions");o.entry=e,o.statusColors=this.config?this.config.statusColors:{},getComputedStyle(t).position==="static"&&(t.style.position="relative"),o.addEventListener("continue",()=>this.handleContinue(e)),o.addEventListener("open-status",r=>this.handleStatus(r,e)),o.addEventListener("open-rating",r=>this.handleRating(r,e)),o.addEventListener("details",()=>this.handleDetails(e)),t.appendChild(o)}handleContinue(t){t.lastReadUrl?window.location.href=t.lastReadUrl:t.sourceUrl&&(window.location.href=t.sourceUrl)}handleStatus(t,e){const o=t.target.getBoundingClientRect();this.mountPicker("bmh-status-picker",{currentStatus:e.status,statusColors:this.config.statusColors,position:{top:o.bottom+8,left:o.left}},r=>{this.updateLibraryEntry(e,{status:r})})}handleRating(t,e){var r;const o=t.target.getBoundingClientRect();this.mountPicker("bmh-rating-picker",{currentRating:((r=e.personalData)==null?void 0:r.rating)||0,position:{top:o.bottom+8,left:o.left}},s=>{const a=e.personalData||{};a.rating=s,this.updateLibraryEntry(e,{personalData:a})})}mountPicker(t,e,o){document.querySelectorAll("bmh-status-picker, bmh-rating-picker").forEach(s=>s.remove());const r=document.createElement(t);Object.assign(r,e),r.addEventListener("select",s=>{o(s.detail[0]),r.remove()}),r.addEventListener("close",()=>r.remove()),document.body.appendChild(r)}async updateLibraryEntry(t,e){var a;let r=(await chrome.storage.local.get(v.LIBRARY))[v.LIBRARY]||[];const s=r.findIndex(n=>n.source===t.source&&n.sourceId===t.id||n.slug&&n.slug===t.slug&&n.source===t.source);if(s!==-1)r[s]={...r[s],...e};else{if(!e.status&&!((a=e.personalData)!=null&&a.rating))return;const n=T({...t,...e});r.push(n)}await chrome.storage.local.set({[v.LIBRARY]:r}),console.log(`[CardEnhancer] Updated entry: ${t.title}`,e)}handleDetails(t){console.log("Details for",t),t.sourceUrl&&window.open(t.sourceUrl,"_blank")}}const at=":root{--bg-body: #0B1437;--bg-sidebar: #111C44;--bg-card: #111C44;--color-primary: #4318FF;--color-primary-rgb: 67, 24, 255;--color-accent: #6AD2FF;--color-bg-base: #0B1437;--color-bg-surface: #111C44;--color-bg-elevated: #111C44;--color-text-primary: #FFFFFF;--color-text-secondary: #A3AED0;--color-text-muted: #707EAE;--color-border: #2B3674;--color-glass-bg: #111C44;--color-success: #01B574;--color-warning: #FFB547;--color-error: #EE5D50;--color-info: #33L1CC}:root{--font-sans: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;--font-mono: JetBrains Mono, Fira Code, Consolas, monospace;--text-xs: .75rem;--text-sm: .875rem;--text-base: 1rem;--text-lg: 1.125rem;--text-xl: 1.25rem;--text-2xl: 1.5rem;--text-3xl: 1.875rem;--text-4xl: 2.25rem}.autoscroll-panel{display:flex;align-items:center;gap:12px;padding:8px 12px;background:#0f0f14f2;border:1px solid rgba(255,255,255,.1);border-radius:12px;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);box-shadow:0 8px 32px #0009;color:#fff;font-family:Inter,system-ui,sans-serif;-webkit-user-select:none;user-select:none;transition:box-shadow .2s}.autoscroll-panel.is-dragging{box-shadow:0 12px 48px #000c,0 0 0 1px #fff3;cursor:grabbing}.toggle-btn{background:#4f46e5;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;min-width:80px;transition:all .2s ease}.toggle-btn:hover{background:#4338ca;transform:translateY(-1px)}.toggle-btn.active{background:#dc2626}.toggle-btn.active:hover{background:#b91c1c}.speed-control{display:flex;align-items:center;gap:8px}.label{font-size:11px;color:#ffffff80;text-transform:uppercase;font-weight:600}.speed-slider{width:80px;height:4px;-webkit-appearance:none;background:#fff3;border-radius:2px;outline:none;cursor:pointer}.speed-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#fff;border-radius:50%;transition:transform .1s}.speed-slider::-webkit-slider-thumb:hover{transform:scale(1.2)}.value{font-size:12px;font-variant-numeric:tabular-nums;width:24px;text-align:right;color:#ffffffe6}.drag-handle{color:#ffffff4d;font-size:18px;cursor:grab;padding:0 4px}.drag-handle:hover{color:#fff}",it={class:"speed-control"},nt=["value"],lt={class:"value"},ct={__name:"AutoScrollPanel.ce",props:{initialSpeed:{type:Number,default:50},initialState:{type:Boolean,default:!1}},emits:["update:speed","toggle"],setup(g,{expose:t,emit:e}){const o=g,r=e,s=S(o.initialSpeed),a=S(o.initialState),n=S(!1),p=()=>{a.value=!a.value,r("toggle",a.value)},x=d=>{const b=parseInt(d.target.value);s.value=b,r("update:speed",b)};let c,i,u,B;const P=d=>{n.value=!0;const b=d.target.getRootNode().host;c=d.clientX,i=d.clientY;const E=b.getBoundingClientRect();u=E.left,B=E.top,window.addEventListener("mousemove",A),window.addEventListener("mouseup",L)},A=d=>{if(!n.value)return;const b=d.clientX-c,E=d.clientY-i,k=d.target.getRootNode().host||d.target.closest("bmh-autoscroll-panel");k&&(k.style.left=`${u+b}px`,k.style.top=`${B+E}px`,k.style.bottom="auto",k.style.right="auto")},L=()=>{n.value=!1,window.removeEventListener("mousemove",A),window.removeEventListener("mouseup",L)};return t({toggle:p,setSpeed:d=>{s.value=d,r("update:speed",d)}}),(d,b)=>(m(),h("div",{class:C(["autoscroll-panel",{"is-dragging":n.value}])},[l("button",{class:C(["toggle-btn",{active:a.value}]),onClick:p,title:"Space to toggle"},w(a.value?"⏸ Stop":"▶ Start"),3),l("div",it,[b[0]||(b[0]=l("span",{class:"label"},"Speed",-1)),l("input",{type:"range",class:"speed-slider",min:"10",max:"300",value:s.value,onInput:x},null,40,nt),l("span",lt,w(s.value),1)]),l("div",{class:"drag-handle",onMousedown:P},"⋮",32)],2))}},dt=$(ct,[["styles",[at]]]),pt=R(dt);customElements.get("bmh-autoscroll-panel")||customElements.define("bmh-autoscroll-panel",pt);class ht{constructor(t){this.adapter=t,this.autoScroll=null,this.config=null,this.settings={autoScrollEnabled:!1,autoScrollSpeed:50,keybindsEnabled:!0},this.scrollInterval=null,this.isScrolling=!1,this.panelElement=null}async init(){console.log("[ReaderEnhancer] Initializing..."),await this.loadSettings(),this.settings.autoScrollEnabled&&this.mountPanel(),this.settings.keybindsEnabled&&this.setupKeybinds(),this.startProgressTracking()}async loadSettings(){this.config=await D.load();const t=await chrome.storage.local.get(["autoScrollEnabled","autoScrollSpeed"]);this.settings.autoScrollEnabled=t.autoScrollEnabled!==!1,this.settings.autoScrollSpeed=t.autoScrollSpeed||50}mountPanel(){document.querySelector("bmh-autoscroll-panel")||(this.panelElement=document.createElement("bmh-autoscroll-panel"),this.panelElement.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
        `,this.panelElement.initialSpeed=this.settings.autoScrollSpeed,this.panelElement.initialState=!1,this.panelElement.addEventListener("toggle",t=>this.toggleScroll(t.detail[0])),this.panelElement.addEventListener("update:speed",t=>this.updateSpeed(t.detail[0])),document.body.appendChild(this.panelElement))}toggleScroll(t){t?this.startScroll():this.stopScroll()}startScroll(){if(this.scrollInterval)return;this.isScrolling=!0;const t=60,o=this.settings.autoScrollSpeed/t;let r=0;this.scrollInterval=setInterval(()=>{const s=this.findScrollTarget();r+=o;const a=Math.floor(r);a>=1&&(s===window?window.scrollBy(0,a):s.scrollTop+=a,r-=a)},1e3/t)}stopScroll(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null),this.isScrolling=!1,this.panelElement}updateSpeed(t){this.settings.autoScrollSpeed=t,chrome.storage.local.set({autoScrollSpeed:t}),this.isScrolling&&(this.stopScroll(),this.startScroll())}findScrollTarget(){const t=["#chapter-reader",".chapter-content",".reader-content",".reading-content","#content",".manga-reader",".read-container","main","article"];for(const e of t){const o=document.querySelector(e);if(o&&o.scrollHeight>o.clientHeight&&getComputedStyle(o).overflowY.includes("auto"))return o}return window}setupKeybinds(){document.addEventListener("keydown",t=>{var e,o,r,s;if(!["INPUT","TEXTAREA","SELECT"].includes(t.target.tagName)&&!(t.ctrlKey||t.altKey||t.metaKey))switch(t.key){case" ":t.preventDefault(),this.isScrolling?(this.toggleScroll(!1),this.panelElement&&this.panelElement.toggle()):(this.toggleScroll(!0),this.panelElement&&this.panelElement.toggle());break;case"ArrowDown":break;case"n":case"N":(o=(e=this.adapter).goToNextChapter)==null||o.call(e);break;case"p":case"P":(s=(r=this.adapter).goToPrevChapter)==null||s.call(r);break}})}startProgressTracking(){setTimeout(()=>{this.saveCurrentChapter()},5e3)}async saveCurrentChapter(){if(!this.adapter.parseUrl)return;const t=this.adapter.parseUrl(window.location.href);if(!t||!t.chapterNo)return;const{slug:e,id:o,chapterNo:r}=t;if(!(!e&&!o))try{const s=await chrome.storage.local.get(["savedReadChapters","savedEntriesMerged"]);let a=s.savedReadChapters||{},n=s.savedEntriesMerged||[];const p=e||`${this.adapter.id}:${o}`;a[p]||(a[p]=[]);const x=String(r);a[p].includes(x)||(a[p].push(x),a[p].sort((i,u)=>parseFloat(i)-parseFloat(u)),await chrome.storage.local.set({savedReadChapters:a}),console.log(`[ReaderEnhancer] Marked ch ${r} as read for ${p}`));const c=n.findIndex(i=>i.source===this.adapter.id&&i.sourceId===o||i.slug&&i.slug===e);if(c!==-1){const i=n[c],u=parseFloat(i.lastReadChapter||0);parseFloat(r)>u&&(i.lastReadChapter=r,i.lastReadUrl=window.location.href,i.lastReadDate=Date.now()),i.readChapters=a[p].length,n[c]=i,await chrome.storage.local.set({savedEntriesMerged:n})}}catch(s){console.error("[ReaderEnhancer] Failed to save progress",s)}}}export{bt as C,ht as R};
