(()=>{"use strict";const t={Reading:"#4ade80",Completed:"#60a5fa","Plan to Read":"#fbbf24","On-Hold":"#f97316","On Hold":"#f97316",Dropped:"#ef4444","Re-reading":"#a855f7",HasHistory:"#9ca3af"};class e{static create(t,n,a={}){const r=document.createElement("div");r.className="bmh-quick-tooltip",r.dataset.entryId=t.slug||t.id||"";const s="episode"===n.unitName?"Ep.":"Ch.",o=parseFloat(t.lastReadChapter)||0,i=e.calculateNextChapter(t),l=e.getStatusColor(t.status),c=t.personalData?.rating||0,d=o>0;return r.innerHTML=`\n            <button class="bmh-tt-btn bmh-tt-continue ${d?"":"bmh-btn-disabled"}" \n                    data-action="continue" \n                    title="${d?`Continue ${s} ${i}`:`Start Reading ${s} 1`}">\n                ▶\n            </button>\n            <button class="bmh-tt-btn bmh-tt-status" data-action="status" title="${t.status||"Set Status"}" style="--status-color: ${l}">\n                <span class="bmh-tt-status-dot" style="background: ${l}"></span>\n            </button>\n            <button class="bmh-tt-btn bmh-tt-rating" data-action="rating" title="Rating: ${c}/10">\n                ${c>0?c:"★"}\n            </button>\n            <button class="bmh-tt-btn bmh-tt-info" data-action="details" title="View Details">\n                ℹ\n            </button>\n        `,e.attachEventListeners(r,t,a),r}static createExpanded(t,n,a={}){const r=document.createElement("div");r.className="bmh-quick-actions bmh-qa-expanded",r.dataset.entryId=t.slug||t.id||"";const s="episode"===n.unitName?"Ep.":"Ch.",o=e.calculateNextChapter(t),i=t.personalData?.rating||0;return r.innerHTML=`\n            <div class="bmh-qa-content">\n                <button class="bmh-qa-btn bmh-qa-continue" data-action="continue" title="Continue to ${s} ${o}">\n                    <span class="bmh-qa-icon">▶</span>\n                    Continue ${s} ${o}\n                </button>\n                <button class="bmh-qa-btn bmh-qa-status" data-action="status" title="Change reading status">\n                    <span class="bmh-qa-status-indicator" style="background: ${e.getStatusColor(t.status)}"></span>\n                    ${t.status||"Add to Library"}\n                </button>\n                <div class="bmh-qa-row">\n                    <div class="bmh-qa-rating" data-action="rating" title="Rate (${i}/10)">\n                        ${e.renderRatingBadge(i)}\n                    </div>\n                    <button class="bmh-qa-btn bmh-qa-details" data-action="details" title="View details">\n                        <span class="bmh-qa-icon">ℹ️</span>\n                    </button>\n                </div>\n            </div>\n        `,e.attachEventListeners(r,t,a),r}static attachEventListeners(t,e,n){t.querySelectorAll("[data-action]").forEach(t=>{t.addEventListener("click",a=>{a.stopPropagation(),a.preventDefault();const r=t.dataset.action;n[r]&&n[r](e,t,a)})})}static calculateNextChapter(t){const e=parseFloat(t.lastReadChapter)||0;return Math.floor(e)+1}static renderRatingBadge(t){return!t||t<=0?'<span class="bmh-rating-badge bmh-rating-empty">-</span>':`<span class="bmh-rating-badge">${t}/10</span>`}static getStatusColor(t){return{reading:"#4ade80",completed:"#60a5fa","plan to read":"#fbbf24",planning:"#fbbf24","on-hold":"#f97316","on hold":"#f97316",dropped:"#ef4444","re-reading":"#a855f7",rereading:"#a855f7"}[(t||"").toLowerCase().trim()]||"rgba(255,255,255,0.3)"}static createStatusPicker(t,n,a=[]){const r=document.createElement("div");r.className="bmh-status-picker";const s=[{name:"Reading",color:"#4ade80"},{name:"Completed",color:"#60a5fa"},{name:"Plan to Read",color:"#fbbf24"},{name:"On-Hold",color:"#f97316"},{name:"Dropped",color:"#ef4444"},{name:"Re-reading",color:"#a855f7"},...a];return r.innerHTML=`\n            <div class="bmh-picker-header">Change Status</div>\n            <div class="bmh-picker-options">\n                ${s.map(e=>`\n                    <button class="bmh-picker-option ${t.status===e.name?"active":""}" \n                            data-status="${e.name}">\n                        <span class="bmh-picker-dot" style="background: ${e.color}"></span>\n                        ${e.name}\n                    </button>\n                `).join("")}\n            </div>\n        `,r.querySelectorAll("[data-status]").forEach(e=>{e.addEventListener("click",a=>{a.stopPropagation(),n?.(e.dataset.status,t),r.remove()})}),e.autoCloseOnOutsideClick(r),r}static createRatingPicker(t,n){const a=document.createElement("div");a.className="bmh-rating-picker";const r=t.personalData?.rating||0;a.innerHTML=`\n            <div class="bmh-picker-header">Rate (1-10)</div>\n            <div class="bmh-rating-grid">\n                ${[1,2,3,4,5,6,7,8,9,10].map(t=>`\n                    <button class="bmh-rating-num ${t===r?"active":""}" \n                            data-rating="${t}">\n                        ${t}\n                    </button>\n                `).join("")}\n            </div>\n            <button class="bmh-rating-clear" data-rating="0">Clear</button>\n        `;const s=a.querySelectorAll(".bmh-rating-num");return s.forEach((t,e)=>{t.addEventListener("mouseenter",()=>{s.forEach((t,n)=>{t.classList.toggle("hovered",n<=e)})})}),a.querySelector(".bmh-rating-grid").addEventListener("mouseleave",()=>{s.forEach(t=>t.classList.remove("hovered"))}),a.querySelectorAll("[data-rating]").forEach(e=>{e.addEventListener("click",r=>{r.stopPropagation();const s=parseInt(e.dataset.rating);n?.(s,t),a.remove()})}),e.autoCloseOnOutsideClick(a),a}static autoCloseOnOutsideClick(t){setTimeout(()=>{const e=n=>{t.contains(n.target)||(t.remove(),document.removeEventListener("click",e))};document.addEventListener("click",e)},0)}static autoCloseOnOutsideClick(t){setTimeout(()=>{const e=n=>{t.contains(n.target)||(t.remove(),document.removeEventListener("click",e))};document.addEventListener("click",e)},0)}static injectStyles(){if(document.getElementById("bmh-overlay-styles"))return;const t=document.createElement("style");t.id="bmh-overlay-styles",t.textContent="\n            /* ===== COMPACT TOOLTIP ===== */\n            .bmh-quick-tooltip {\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                display: flex;\n                gap: 4px;\n                opacity: 0;\n                transform: translateY(-4px);\n                transition: all 0.2s ease;\n                z-index: 60;\n                pointer-events: none;\n            }\n\n            [data-bmh-enhanced]:hover .bmh-quick-tooltip {\n                opacity: 1;\n                transform: translateY(0);\n                pointer-events: auto;\n            }\n\n            .bmh-tt-btn {\n                width: 28px;\n                height: 28px;\n                border: none;\n                border-radius: 6px;\n                background: rgba(0, 0, 0, 0.85);\n                color: #fff;\n                font-size: 12px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s ease;\n                backdrop-filter: blur(8px);\n                box-shadow: 0 2px 8px rgba(0,0,0,0.4);\n            }\n\n            .bmh-tt-btn:hover {\n                transform: scale(1.1);\n                background: rgba(30, 30, 30, 0.95);\n            }\n\n            .bmh-tt-continue {\n                background: linear-gradient(135deg, #4CAF50, #388e3c);\n            }\n\n            .bmh-tt-continue.bmh-btn-disabled {\n                background: rgba(80, 80, 80, 0.8);\n                opacity: 0.7;\n                filter: grayscale(1);\n                box-shadow: none;\n            }\n\n            .bmh-tt-continue:not(.bmh-btn-disabled):hover {\n                background: linear-gradient(135deg, #66BB6A, #43A047);\n            }\n\n            .bmh-tt-status-dot {\n                width: 10px;\n                height: 10px;\n                border-radius: 50%;\n            }\n\n            .bmh-tt-rating {\n                font-weight: 700;\n                color: #fbbf24;\n            }\n\n            .bmh-tt-info {\n                font-size: 14px;\n            }\n\n            /* ===== PICKERS (Status & Rating) ===== */\n            .bmh-status-picker,\n            .bmh-rating-picker {\n                position: fixed;\n                background: rgba(20, 20, 25, 0.98);\n                border: 1px solid rgba(255, 255, 255, 0.12);\n                border-radius: 12px;\n                padding: 12px;\n                min-width: 180px;\n                z-index: 10000;\n                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);\n                backdrop-filter: blur(16px);\n                animation: bmh-picker-slide 0.2s ease-out;\n            }\n\n            @keyframes bmh-picker-slide {\n                from { opacity: 0; transform: scale(0.95) translateY(-8px); }\n                to { opacity: 1; transform: scale(1) translateY(0); }\n            }\n\n            .bmh-picker-header {\n                font-size: 11px;\n                color: rgba(255, 255, 255, 0.5);\n                text-transform: uppercase;\n                letter-spacing: 1px;\n                padding-bottom: 8px;\n                margin-bottom: 8px;\n                border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n            }\n\n            .bmh-picker-options {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .bmh-picker-option {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                width: 100%;\n                padding: 10px 12px;\n                background: transparent;\n                border: none;\n                border-radius: 8px;\n                color: #fff;\n                font-size: 13px;\n                cursor: pointer;\n                transition: all 0.15s ease;\n                text-align: left;\n            }\n\n            .bmh-picker-option:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .bmh-picker-option.active {\n                background: rgba(255, 255, 255, 0.15);\n            }\n\n            .bmh-picker-dot {\n                width: 10px;\n                height: 10px;\n                border-radius: 50%;\n                flex-shrink: 0;\n            }\n\n            /* Rating Grid (1-10) */\n            .bmh-rating-grid {\n                display: grid;\n                grid-template-columns: repeat(5, 1fr);\n                gap: 6px;\n                margin-bottom: 10px;\n            }\n\n            .bmh-rating-num {\n                width: 36px;\n                height: 36px;\n                border: 1px solid rgba(255, 255, 255, 0.15);\n                border-radius: 8px;\n                background: transparent;\n                color: #fff;\n                font-size: 14px;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.15s ease;\n            }\n\n            .bmh-rating-num:hover,\n            .bmh-rating-num.hovered {\n                background: rgba(251, 191, 36, 0.3);\n                border-color: #fbbf24;\n                color: #fbbf24;\n            }\n\n            .bmh-rating-num.active {\n                background: #fbbf24;\n                border-color: #fbbf24;\n                color: #000;\n            }\n\n            .bmh-rating-clear {\n                width: 100%;\n                padding: 8px;\n                background: transparent;\n                border: 1px solid rgba(255, 255, 255, 0.1);\n                border-radius: 6px;\n                color: rgba(255, 255, 255, 0.6);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.15s ease;\n            }\n\n            .bmh-rating-clear:hover {\n                background: rgba(255, 255, 255, 0.08);\n                color: #fff;\n            }\n\n            /* Rating Badge */\n            .bmh-rating-badge {\n                color: #fbbf24;\n                font-weight: 600;\n                font-size: 13px;\n            }\n\n            .bmh-rating-empty {\n                opacity: 0.5;\n            }\n\n            /* Animation keyframes */\n            @keyframes bmh-pulse {\n                0%, 100% { opacity: 1; transform: scale(1); }\n                50% { opacity: 0.8; transform: scale(1.05); }\n            }\n        ",document.head.appendChild(t)}static injectPickerStyles(){e.injectStyles()}}class n{constructor(t,e={}){this.adapter=t,this.settings={highlighting:!1!==e.highlighting,progressBadges:!1!==e.progressBadges,quickActions:!0===e.quickActions,newChapterBadges:!0===e.newChapterBadges,border:{size:e.CustomBorderSize||4,style:e.borderStyle||"solid",radius:"8px"},customBookmarks:e.customBookmarks||[],customBookmarksEnabled:e.CustomBookmarksfeatureEnabled||!1}}async enhanceAll(){const t=this.findCards(),e=await this.loadLibrary();let n=0;for(const a of t){if(a.element.dataset.bmhEnhanced)continue;const t=this.findMatch(a,e);t&&(this.applyEnhancements(a,t),n++),a.element.dataset.bmhEnhanced="true"}return n}findCards(){const t=this.adapter.selectors.card;return t?Array.from(document.querySelectorAll(t)).map(t=>({element:t,data:this.adapter.extractCardData(t)})).filter(t=>t.data.title||t.data.id):[]}async loadLibrary(){return new Promise(t=>{chrome.storage.local.get(["savedEntriesMerged","userBookmarks","savedReadChapters"],e=>{if(chrome.runtime.lastError)return void t([]);const n=Array.isArray(e.savedEntriesMerged)?e.savedEntriesMerged:[],a=Array.isArray(e.userBookmarks)?e.userBookmarks:[],r=e.savedReadChapters||{},s=new Map;[...a,...n].forEach(t=>{if(t?.title){const e=this.findHistoryKey(t.title,t.slug,r);t.readChapters=e?r[e]:[],t.lastReadChapter=this.getHighestChapter(t.readChapters),s.set(t.title,t)}}),t(Array.from(s.values()))})})}findHistoryKey(t,e,n){if(!n)return null;if(e){const t=`${this.adapter.PREFIX||""}${e}`;if(n[t])return t;if(n[e])return e;if(e.includes(".")){const t=e.substring(0,e.lastIndexOf("."));if(n[t])return t}}if(n[t])return t;const a=this.normalizeTitle(t);for(const t of Object.keys(n))if(this.normalizeTitle(t)===a)return t;return null}findMatch(t,e){const n=e.find(e=>e.source===this.adapter.id&&e.sourceId===t.data.id);if(n)return n;const a=this.normalizeTitle(t.data.title);return e.find(t=>this.normalizeTitle(t.title)===a)}applyEnhancements(t,e){this.settings.highlighting&&this.applyBorder(t,e),this.settings.progressBadges&&e.readChapters?.length>0&&this.applyProgressBadge(t,e),this.settings.newChapterBadges&&e.hasNewChapters&&this.applyNewBadge(t),this.settings.quickActions&&this.applyQuickActions(t,e)}applyBorder(e,n){const a=n.status?.trim().toLowerCase()||"";let r="transparent",s=this.settings.border.style;for(const[e,n]of Object.entries(t))if(a.includes(e.toLowerCase())){r=n;break}if(this.settings.customBookmarksEnabled&&this.settings.customBookmarks.forEach(t=>{t.name&&a.includes(t.name.toLowerCase())&&(r=t.color,s=t.style||"solid")}),"transparent"!==r)if(this.adapter.applyBorder)this.adapter.applyBorder(e.element,r,this.settings.border.size,s);else{const t=e.element.closest("li")||e.element;t.style.setProperty("border",`${this.settings.border.size}px ${s} ${r}`,"important"),t.style.setProperty("border-radius",this.settings.border.radius,"important"),t.style.setProperty("box-sizing","border-box","important")}}applyProgressBadge(t,e){const n="episode"===this.adapter.unitName?"Ep.":"Ch.",a=e.chapters||e.anilistData?.chapters,r=a?`${n} ${e.lastReadChapter}/${a}`:`${n} ${e.lastReadChapter}+`,s=this.createBadge(r,"progress"),o=this.adapter.getBadgePosition?.()||{bottom:"4px",left:"4px"};Object.assign(s.style,o),this.insertBadge(t.element,s)}applyNewBadge(t){const e=this.createBadge("NEW","new");e.style.cssText+="top: 4px; right: 4px;",this.insertBadge(t.element,e)}applyQuickActions(t,n){e.injectStyles();const a={continue:(e,n,a)=>this.handleContinueReading(e,t),status:(e,n,a)=>this.handleStatusChange(e,n,t),rating:(e,n,a)=>this.handleRatingChange(e,n,t),details:(e,n,a)=>this.handleViewDetails(e,t)},r=e.create(n,this.adapter,a);t.element.style.position="relative",t.element.appendChild(r)}handleContinueReading(t,n){const a=e.calculateNextChapter(t),r=this.adapter.buildChapterUrl?.(t,a);r?window.location.href=r:t.mangafireUrl||t.sourceUrl?window.location.href=t.mangafireUrl||t.sourceUrl:n.data.url?window.location.href=n.data.url:console.log("[CardEnhancer] No URL available for continue reading:",t)}handleStatusChange(t,n,a){document.querySelectorAll(".bmh-status-picker").forEach(t=>t.remove());const r=e.createStatusPicker(t,(t,e)=>this.saveStatusChange(e,t),this.settings.customBookmarks),s=n.getBoundingClientRect();r.style.left=`${s.left}px`,r.style.top=`${s.bottom+8}px`,document.body.appendChild(r)}handleRatingChange(t,n,a){document.querySelectorAll(".bmh-rating-picker").forEach(t=>t.remove());const r=e.createRatingPicker(t,(t,e)=>this.saveRatingChange(e,t)),s=n.getBoundingClientRect();r.style.left=`${s.left}px`,r.style.top=`${s.bottom+8}px`,document.body.appendChild(r)}handleViewDetails(t,e){chrome.runtime.sendMessage({type:"showMangaDetails",title:t.title},()=>{chrome.runtime.lastError&&console.log("[CardEnhancer] Error opening details:",chrome.runtime.lastError)})}async saveStatusChange(t,e){try{const n=await new Promise(t=>{chrome.storage.local.get(["savedEntriesMerged","userBookmarks"],t)}),a=n.savedEntriesMerged||[],r=n.userBookmarks||[],s=a.findIndex(e=>this.normalizeTitle(e.title)===this.normalizeTitle(t.title));-1!==s&&(a[s].status=e);const o=r.findIndex(e=>this.normalizeTitle(e.title)===this.normalizeTitle(t.title));-1!==o&&(r[o].status=e),await new Promise(t=>{chrome.storage.local.set({savedEntriesMerged:a,userBookmarks:r},t)}),console.log(`[CardEnhancer] Status updated: ${t.title} → ${e}`),this.enhanceAll()}catch(t){console.error("[CardEnhancer] Failed to save status:",t)}}async saveRatingChange(t,e){try{const n=(await new Promise(t=>{chrome.storage.local.get(["savedEntriesMerged"],t)})).savedEntriesMerged||[],a=n.findIndex(e=>this.normalizeTitle(e.title)===this.normalizeTitle(t.title));-1!==a&&(n[a].personalData||(n[a].personalData={}),n[a].personalData.rating=e,await new Promise(t=>{chrome.storage.local.set({savedEntriesMerged:n},t)}),console.log(`[CardEnhancer] Rating updated: ${t.title} → ${e}`))}catch(t){console.error("[CardEnhancer] Failed to save rating:",t)}}createBadge(t,e){const n=document.createElement("div");return n.className=`bmh-badge bmh-badge-${e}`,n.textContent=t,n.style.cssText="\n            position: absolute;\n            background: rgba(0, 0, 0, 0.85);\n            color: #fff;\n            font-size: 11px;\n            font-weight: 600;\n            padding: 4px 8px;\n            border-radius: 6px;\n            z-index: 20;\n            pointer-events: none;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n            border: 1px solid rgba(255,255,255,0.1);\n        ","new"===e&&(n.style.background="#ef4444",n.style.animation="bmh-pulse 2s infinite"),n}insertBadge(t,e){const n=t.querySelector(`.bmh-badge-${e.classList[1]?.replace("bmh-badge-","")}`);n&&n.remove();const a=t.querySelector('div[class*="cover"], div[class*="thumb"], [class*="img"]')?.parentElement||t;a.style.position="relative",a.appendChild(e)}normalizeTitle(t){return t?t.toLowerCase().replace(/[^a-z0-9]/g,""):""}getHighestChapter(t){if(!t||0===t.length)return 0;let e=0;return t.forEach(t=>{const n=String(t).match(/^(\d+\.?\d*)/);if(n){const t=parseFloat(n[1]);t>e&&(e=t)}}),e}}const a=class{constructor(t={}){this.speed=t.speed||50,this.isRunning=!1,this.intervalId=null,this.showPanel=!1!==t.showPanel,this.panel=null,this.scrollTarget=null,this.lastScrollPos=-1,this.stuckCount=0}findScrollTarget(){const t=["#chapter-reader",".chapter-content",".reader-content",".reading-content","#content",".manga-reader",".read-container","main","article",".container"];for(const e of t){const t=document.querySelector(e);if(t){const e=window.getComputedStyle(t);if(("auto"===e.overflow||"scroll"===e.overflow||"auto"===e.overflowY||"scroll"===e.overflowY)&&t.scrollHeight>t.clientHeight)return{element:t,useElement:!0}}}const e=document.documentElement;if(document.body.scrollHeight>window.innerHeight||e.scrollHeight>window.innerHeight)return{element:window,useElement:!1};const n=document.querySelectorAll("*");for(const t of n)if(t.scrollHeight>t.clientHeight+100){const e=window.getComputedStyle(t);if("auto"===e.overflow||"scroll"===e.overflow||"auto"===e.overflowY||"scroll"===e.overflowY)return{element:t,useElement:!0}}return{element:window,useElement:!1}}getScrollPos(){return this.scrollTarget.useElement?this.scrollTarget.element.scrollTop:window.scrollY||window.pageYOffset||document.documentElement.scrollTop}doScroll(t){this.scrollTarget.useElement?this.scrollTarget.element.scrollTop+=t:window.scrollBy(0,t)}start(){if(this.isRunning)return;this.scrollTarget=this.findScrollTarget(),this.isRunning=!0,this.lastScrollPos=this.getScrollPos(),this.stuckCount=0;const t=this.speed/60;this.intervalId=setInterval(()=>{if(!this.isRunning)return void this.stop();this.doScroll(t);const e=this.getScrollPos();if(Math.abs(e-this.lastScrollPos)<.1){if(this.stuckCount++,this.stuckCount>60)return void this.stop()}else this.stuckCount=0;this.lastScrollPos=e},1e3/60),this.updatePanelState()}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.isRunning=!1,this.updatePanelState()}toggle(){this.isRunning?this.stop():this.start()}setSpeed(t){this.speed=Math.max(10,Math.min(300,t)),this.isRunning&&(this.stop(),this.start())}updatePanelState(){if(!this.panel)return;const t=this.panel.querySelector(".bmh-as-toggle");t&&(t.textContent=this.isRunning?"⏸ Stop":"▶ Start",t.className="bmh-as-toggle"+(this.isRunning?" active":""))}createControlPanel(){const t=document.querySelector(".bmh-autoscroll-panel");t&&t.remove();const e=document.createElement("div");e.className="bmh-autoscroll-panel",e.innerHTML=`\n            <button class="bmh-as-toggle" type="button">▶ Start</button>\n            <div class="bmh-as-speed-control">\n                <span class="bmh-as-label">Speed:</span>\n                <input type="range" class="bmh-as-speed" min="20" max="200" value="${this.speed}">\n                <span class="bmh-as-speed-value">${this.speed}</span>\n            </div>\n        `;const n=this;e.querySelector(".bmh-as-toggle").onclick=function(t){return t.preventDefault(),t.stopPropagation(),n.toggle(),!1};const a=e.querySelector(".bmh-as-speed"),r=e.querySelector(".bmh-as-speed-value");return a.oninput=function(t){const e=parseInt(t.target.value);n.setSpeed(e),r.textContent=e},this.injectStyles(),document.body.appendChild(e),this.panel=e,e}injectStyles(){if(document.getElementById("bmh-autoscroll-styles"))return;const t=document.createElement("style");t.id="bmh-autoscroll-styles",t.textContent="\n            .bmh-autoscroll-panel {\n                position: fixed !important;\n                bottom: 20px !important;\n                right: 20px !important;\n                background: rgba(0, 0, 0, 0.95) !important;\n                border: 1px solid rgba(255, 255, 255, 0.2) !important;\n                border-radius: 10px !important;\n                padding: 10px 14px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 10px !important;\n                z-index: 2147483647 !important;\n                font-family: -apple-system, BlinkMacSystemFont, sans-serif !important;\n                font-size: 13px !important;\n                color: white !important;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;\n            }\n            .bmh-as-toggle {\n                background: #4f46e5 !important;\n                color: white !important;\n                border: none !important;\n                padding: 8px 14px !important;\n                border-radius: 6px !important;\n                font-size: 12px !important;\n                font-weight: 600 !important;\n                cursor: pointer !important;\n                min-width: 70px !important;\n            }\n            .bmh-as-toggle:hover { background: #4338ca !important; }\n            .bmh-as-toggle.active { background: #dc2626 !important; }\n            .bmh-as-toggle.active:hover { background: #b91c1c !important; }\n            .bmh-as-speed-control {\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .bmh-as-label {\n                color: rgba(255, 255, 255, 0.7) !important;\n                font-size: 11px !important;\n            }\n            .bmh-as-speed {\n                width: 60px !important;\n                height: 4px !important;\n                -webkit-appearance: none !important;\n                background: rgba(255, 255, 255, 0.3) !important;\n                border-radius: 2px !important;\n            }\n            .bmh-as-speed::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                width: 12px !important;\n                height: 12px !important;\n                background: white !important;\n                border-radius: 50% !important;\n            }\n            .bmh-as-speed-value {\n                color: rgba(255, 255, 255, 0.9) !important;\n                font-size: 11px !important;\n                min-width: 24px !important;\n            }\n        ",document.head.appendChild(t)}init(){this.showPanel&&this.createControlPanel(),window.bmhAutoScroll=this}destroy(){this.stop(),this.panel&&(this.panel.remove(),this.panel=null),delete window.bmhAutoScroll}};class r{static defaults={ArrowDown:"scrollDown",ArrowUp:"scrollUp"," ":"toggleAutoScroll",Escape:"exitReader",f:"toggleFullscreen",F:"toggleFullscreen",n:"nextChapter",N:"nextChapter",p:"prevChapter",P:"prevChapter",Home:"scrollToTop",End:"scrollToBottom"};constructor(t){this.adapter=t,this.bindings=new Map,this.enabled=!0,this.boundHandler=this.handleKey.bind(this)}async loadBindings(){try{const t=(await chrome.storage.local.get("keybinds")).keybinds||{},e={...r.defaults,...t};Object.entries(e).forEach(([t,e])=>{this.bindings.set(t,e)}),console.log("[Keybinds] Loaded",this.bindings.size,"bindings")}catch(t){console.warn("[Keybinds] Failed to load bindings:",t),Object.entries(r.defaults).forEach(([t,e])=>{this.bindings.set(t,e)})}}async saveBindings(){try{const t=Object.fromEntries(this.bindings);await chrome.storage.local.set({keybinds:t})}catch(t){console.warn("[Keybinds] Failed to save bindings:",t)}}start(){document.addEventListener("keydown",this.boundHandler,{capture:!0}),console.log("[Keybinds] Started listening")}stop(){document.removeEventListener("keydown",this.boundHandler,{capture:!0}),console.log("[Keybinds] Stopped listening")}setEnabled(t){this.enabled=t}handleKey(t){if(!this.enabled)return;if(["INPUT","TEXTAREA","SELECT"].includes(t.target.tagName))return;if(t.target.isContentEditable)return;if(t.ctrlKey||t.altKey||t.metaKey)return;const e=this.bindings.get(t.key);e&&(t.preventDefault(),t.stopPropagation(),this.executeAction(e))}executeAction(t){const e={nextPage:()=>this.adapter.goToNextPage?.()||this.scrollPage(1),prevPage:()=>this.adapter.goToPrevPage?.()||this.scrollPage(-1),nextChapter:()=>this.adapter.goToNextChapter?.(),prevChapter:()=>this.adapter.goToPrevChapter?.(),scrollDown:()=>window.scrollBy({top:.5*window.innerHeight,behavior:"smooth"}),scrollUp:()=>window.scrollBy({top:.5*-window.innerHeight,behavior:"smooth"}),scrollToTop:()=>window.scrollTo({top:0,behavior:"smooth"}),scrollToBottom:()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),toggleAutoScroll:()=>window.bmhAutoScroll?.toggle(),speedUp:()=>{window.bmhAutoScroll&&window.bmhAutoScroll.setSpeed(window.bmhAutoScroll.speed+20)},speedDown:()=>{window.bmhAutoScroll&&window.bmhAutoScroll.setSpeed(window.bmhAutoScroll.speed-20)},toggleFullscreen:()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(t=>{console.warn("[Keybinds] Fullscreen failed:",t)})},exitReader:()=>{document.fullscreenElement?document.exitFullscreen():this.adapter.exitReader?.()}}[t];e?(e(),console.log("[Keybinds] Executed:",t)):console.warn("[Keybinds] Unknown action:",t)}scrollPage(t){window.scrollBy({top:.5*window.innerHeight*t,behavior:"smooth"})}setBinding(t,e){this.bindings.set(t,e),this.saveBindings()}removeBinding(t){this.bindings.delete(t),this.saveBindings()}resetToDefaults(){this.bindings.clear(),Object.entries(r.defaults).forEach(([t,e])=>{this.bindings.set(t,e)}),this.saveBindings()}async init(){await this.loadBindings(),this.start(),window.bmhKeybinds=this,console.log("[Keybinds] Initialized")}destroy(){this.stop(),delete window.bmhKeybinds}}const s=r;class o{static SAVE_DELAY=5e3;constructor(t){this.adapter=t,this.currentEntry=null,this.saveTimeout=null,this.isSaved=!1}async init(){const t=this.parseCurrentUrl();t&&t.chapterNo?(this.currentEntry={source:this.adapter.id||this.adapter.PREFIX,slug:t.slug,id:t.id,chapter:String(t.chapterNo),url:window.location.href},console.log("[ProgressTracker] Tracking:",this.currentEntry),this.saveTimeout=setTimeout(()=>this.saveProgress(),o.SAVE_DELAY),this.setupScrollTracking()):console.log("[ProgressTracker] Not a chapter page, skipping")}parseCurrentUrl(){if(this.adapter.parseUrl)return this.adapter.parseUrl(window.location.href);const t=window.location.href,e=t.match(/\/read\/([^/]+)\.(\d+)\/\w+\/chapter-(\d+(?:\.\d+)?)/);if(e)return{slug:e[1],id:e[2],chapterNo:parseFloat(e[3])};const n=t.match(/mangadex\.org\/chapter\/([a-f0-9-]+)/i);if(n)return{chapterId:n[1],chapterNo:null};const a=t.match(/webtoons\.com.*episode_no=(\d+)/i);if(a){const e=t.match(/\/([^/]+)\/list\?/);return{slug:e?.[1]||"unknown",chapterNo:parseInt(a[1])}}return null}setupScrollTracking(){let t=!1;window.addEventListener("scroll",()=>{t||this.isSaved||window.scrollY/(document.body.scrollHeight-window.innerHeight)>.25&&(t=!0,this.saveProgress())},{passive:!0})}async saveProgress(){if(this.isSaved||!this.currentEntry)return;this.isSaved=!0;const{source:t,slug:e,chapter:n,url:a,id:r}=this.currentEntry;try{const s=e||`${t}:${r}`,o=await chrome.storage.local.get(["savedReadChapters","savedEntriesMerged"]),i=o.savedReadChapters||{},l=o.savedEntriesMerged||[];i[s]||(i[s]=[]),i[s].includes(n)||(i[s].push(n),i[s].sort((t,e)=>parseFloat(t)-parseFloat(e)));const c=l.find(n=>{if(n.source===t&&n.sourceId===r)return!0;if(n.slug===e||n.slug===s)return!0;const a=e?.toLowerCase().replace(/[^a-z0-9]/g,""),o=(n.slug||n.title||"").toLowerCase().replace(/[^a-z0-9]/g,"");return a&&a===o});if(c){parseFloat(n)>(parseFloat(c.lastReadChapter)||0)&&(c.lastReadChapter=n,c.lastMangafireUrl=a),c.lastReadDate=Date.now(),c.readChapters=i[s].length,console.log("[ProgressTracker] Updated library entry:",c.title||e)}await chrome.storage.local.set({savedReadChapters:i,savedEntriesMerged:l}),console.log(`[ProgressTracker] ✓ Saved progress: ${e} ch.${n}`);try{chrome.runtime.sendMessage({action:"progressSaved",data:{source:t,slug:e,chapter:n}})}catch(t){}}catch(t){console.error("[ProgressTracker] Failed to save progress:",t),this.isSaved=!1}}destroy(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null)}}const i=o,l=class{constructor(t,e={}){this.adapter=t,this.options={autoScroll:!1!==e.autoScroll,keybinds:!1!==e.keybinds,progressTracking:!1!==e.progressTracking},this.autoScroll=null,this.keybinds=null,this.progressTracker=null,this.isInitialized=!1}isReaderPage(){if(this.adapter.isReaderPage)return this.adapter.isReaderPage();const t=window.location.href;return[/\/read\//i,/\/chapter\//i,/episode_no=/i,/\/viewer/i,/chapter-\d+/i].some(e=>e.test(t))}async init(){if(!this.isReaderPage())return void console.log("[ReaderEnhancements] Not a reader page, skipping init");console.log("[ReaderEnhancements] Initializing on reader page...");const t=await this.loadSettings();this.options.autoScroll&&!1!==t.autoScrollEnabled&&(this.autoScroll=new a({speed:t.autoScrollSpeed||50,showPanel:!0}),this.autoScroll.init()),this.options.keybinds&&!1!==t.keybindsEnabled&&(this.keybinds=new s(this.adapter),await this.keybinds.init()),this.options.progressTracking&&!1!==t.progressTrackingEnabled&&(this.progressTracker=new i(this.adapter),await this.progressTracker.init()),this.isInitialized=!0,console.log("[ReaderEnhancements] Initialized successfully")}async loadSettings(){try{return await chrome.storage.local.get(["autoScrollEnabled","autoScrollSpeed","keybindsEnabled","progressTrackingEnabled"])}catch(t){return console.warn("[ReaderEnhancements] Failed to load settings:",t),{}}}destroy(){this.autoScroll?.destroy(),this.keybinds?.destroy(),this.progressTracker?.destroy(),this.autoScroll=null,this.keybinds=null,this.progressTracker=null,this.isInitialized=!1}},c={id:"manganato",name:"Manganato",unitName:"chapter",PREFIX:"manganato:",selectors:{cardContainer:".panel-content-genres, .daily-update, .truyen-list",card:".content-genres-item, .list-truyen-item-wrap, .sh",cardTitle:"h3 a, a.genres-item-name",cardLink:"h3 a, a.genres-item-name",cardCover:"img"},extractCardData(t){let e="",n="",a="";const r=t.querySelector(this.selectors.cardLink)||("A"===t.tagName?t:null);return r&&(e=r.getAttribute("title")||r.textContent?.trim()||"",n=r.href,a=this.extractSlug(n)),{id:a,title:e,slug:a,url:n}},extractSlug(t){try{return new URL(t).pathname.replace(/^\//,"").split("/")[0]}catch(t){return""}},applyBorder(t,e,n,a){t.style.setProperty("border",`${n}px ${a} ${e}`,"important"),t.style.setProperty("border-radius","5px","important"),t.style.setProperty("box-sizing","border-box","important"),t.style.setProperty("position","relative","important")},getBadgePosition:()=>({bottom:"4px",left:"4px"}),buildChapterUrl:(t,e)=>null,isReaderPage:()=>window.location.pathname.includes("chapter-"),parseUrl(t){const e=t.match(/\/([^/]+)\/chapter-([\d.-]+)/);return e?{slug:e[1],chapterNo:parseFloat(e[2])}:null},goToNextChapter(){const t=document.querySelector(".navi-change-chapter-btn-next");t&&t.click()},goToPrevChapter(){const t=document.querySelector(".navi-change-chapter-btn-prev");t&&t.click()},exitReader(){const t=document.querySelector(".panel-breadcrumb a:last-child")||document.querySelector('a[href*="/manga-"]');t?t.click():window.history.back()}};function d(){if(!chrome.runtime?.id)return;const t=window.location.href,e=function(t){try{const e=new URL(t).pathname.split("/").find(t=>t.startsWith("chapter-"));return e?e.replace("chapter-",""):null}catch(t){return null}}(t);if(!e)return;const n=document.querySelector(".panel-chapter-info-top h1, .story-info-right h1"),a=n?.textContent?.trim();if(!a)return;const r=c.extractSlug(t),s=`${c.PREFIX}${r}`;chrome.storage.local.get(["savedReadChapters"],t=>{if(chrome.runtime.lastError)return;let n=t.savedReadChapters||{},o=!1;n[s]||(n[s]=[]),n[s].includes(e)||(n[s].push(e),o=!0);const i=n[s].length;chrome.runtime.sendMessage({type:"autoSyncEntry",title:a,chapter:e,slugWithId:`manganato-${r}`,readChapters:i,source:"manganato"},()=>{chrome.runtime.lastError}),o&&chrome.storage.local.set({savedReadChapters:n},()=>{chrome.runtime.lastError||h(`Saved chapter ${e} for ${a}`)})})}function h(t){if(!chrome.runtime?.id)return;const e="object"==typeof t?JSON.stringify(t):t;chrome.runtime.sendMessage({type:"log",text:`[Manganato] ${e}`},()=>{chrome.runtime.lastError})}async function p(){if(!chrome.runtime?.id)return;h("Manganato CardEnhancer v3.8.0 (Bundled) initializing..."),function(){if(document.getElementById("bmh-manganato-styles"))return;const t=document.createElement("style");t.id="bmh-manganato-styles",t.textContent="\n        @keyframes bmh-pulse {\n            0%, 100% { opacity: 1; transform: scale(1); }\n            50% { opacity: 0.8; transform: scale(1.05); }\n        }\n        .bmh-progress-badge {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        }\n    ",document.head.appendChild(t),e.injectStyles()}();const t=await new Promise(t=>{chrome.storage.local.get(["ManganatoHighlightEnabled","ManganatoQuickActionsEnabled","CustomBorderSize","CustomBorderSizefeatureEnabled","CustomBookmarksfeatureEnabled","customBookmarks","ManganatoShowProgress"],e=>{chrome.runtime.lastError?t({}):t(e)})});if(!1===t.ManganatoHighlightEnabled)return void h("Highlighting disabled");const a=new n(c,{highlighting:!0,progressBadges:!1!==t.ManganatoShowProgress,quickActions:!1!==t.ManganatoQuickActionsEnabled,CustomBorderSize:t.CustomBorderSizefeatureEnabled?t.CustomBorderSize:4,CustomBookmarksfeatureEnabled:t.CustomBookmarksfeatureEnabled,customBookmarks:t.customBookmarks});let r;h(`Enhanced ${await a.enhanceAll()} cards`),window.location.pathname.includes("chapter-")&&(d(),new l(c).init(),h("Reader enhancements initialized")),new MutationObserver(()=>{clearTimeout(r),r=setTimeout(()=>a.enhanceAll(),200)}).observe(document.body,{childList:!0,subtree:!0})}window.addEventListener("load",()=>{setTimeout(p,500)});let u=location.href;new MutationObserver(()=>{chrome.runtime?.id&&location.href!==u&&(u=location.href,document.querySelectorAll("[data-bmh-enhanced]").forEach(t=>{delete t.dataset.bmhEnhanced}),setTimeout(p,500),location.pathname.includes("chapter-")&&setTimeout(d,500))}).observe(document,{subtree:!0,childList:!0})})();
//# sourceMappingURL=content-manganato.js.map